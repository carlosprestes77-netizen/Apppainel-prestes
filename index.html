<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel Prestes</title>
  <meta name="theme-color" content="#f5f5fa" />
  <link rel="manifest" href="manifest.webmanifest" />

  <style>
    :root {
      --bg: #f5f5fa;
      --bg-card: #ffffff;
      --border: #e1e1f0;
      --text-main: #222235;
      --text-soft: #6a6a88;
      --accent: #8a7bff;
      --accent-soft: #d6d1ff;
      --accent-bg: #f3f1ff;
      --danger: #ff6b6b;
      --success: #3bb273;
    }

    body.dark {
      --bg: #111119;
      --bg-card: #181824;
      --border: #27273a;
      --text-main: #f7f7ff;
      --text-soft: #a7a7d0;
      --accent: #b19bff;
      --accent-soft: #7268ff;
      --accent-bg: #222236;
      --danger: #ff857a;
      --success: #6fd7a3;
      background: #111119;
      color: var(--text-main);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text-main);
      padding: 16px 10px 40px;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
    }

    /* HEADER */

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 14px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo {
      width: 52px;
      height: 52px;
      border-radius: 18px;
      background: radial-gradient(circle at top left, #ffffff, #cabdff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 1.2rem;
      color: #262235;
      border: 1px solid #ded6ff;
    }

    body.dark .logo {
      background: radial-gradient(circle at top left, #292940, #5c4cff);
      color: #f7f7ff;
      border-color: #4540a8;
    }

    .title-block h1 {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .title-block p {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .theme-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f0efff;
      padding: 6px 10px;
      font-size: 0.8rem;
      cursor: pointer;
      color: var(--text-soft);
    }

    body.dark .theme-btn {
      background: #24243a;
      border-color: #34345a;
      color: #d0cff5;
    }

    /* TABS */

    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }

    .tab-btn {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: #e8e8f5;
      color: var(--text-soft);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: 0.15s;
    }

    body.dark .tab-btn {
      background: #202035;
    }

    .tab-btn.active {
      background: var(--accent);
      color: #ffffff;
      border-color: #7265ff;
    }

    .tab-panel {
      display: none;
    }
    .tab-panel.active {
      display: block;
    }

    /* CARD */

    .card {
      background: var(--bg-card);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
      margin-bottom: 12px;
    }

    body.dark .card {
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .card-sub {
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    /* INPUTS */

    label {
      font-size: 0.75rem;
      color: var(--text-soft);
      display: block;
      margin-bottom: 3px;
    }

    input[type="text"],
    input[type="number"],
    input[type="month"],
    textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fafaff;
      padding: 7px 9px;
      font-size: 0.85rem;
      margin-bottom: 8px;
      color: var(--text-main);
    }

    body.dark input[type="text"],
    body.dark input[type="number"],
    body.dark input[type="month"],
    body.dark textarea {
      background: #1e1e30;
      border-color: #343458;
      color: #f5f5ff;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    input::placeholder,
    textarea::placeholder {
      color: #a2a2c0;
    }

    .row {
      display: flex;
      gap: 8px;
    }
    .row > div {
      flex: 1;
    }

    .checkbox-line {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .checkbox-line input {
      width: auto;
      accent-color: var(--accent);
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      background: var(--accent);
      color: #fff;
      width: 100%;
      margin-top: 4px;
    }

    button.secondary {
      background: #f0f0ff;
      color: var(--text-soft);
      width: auto;
    }

    body.dark button.secondary {
      background: #23233a;
      color: var(--text-soft);
    }

    button.small {
      padding: 4px 10px;
      font-size: 0.75rem;
    }

    /* DASHBOARD */

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 6px;
      margin-top: 8px;
    }

    .summary-item {
      background: var(--accent-bg);
      border-radius: 12px;
      padding: 6px 8px;
    }

    body.dark .summary-item {
      background: #23233a;
    }

    .summary-label {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .summary-value {
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 3px;
    }

    .summary-value.green { color: var(--success); }
    .summary-value.red { color: var(--danger); }

    .bar-wrap {
      margin-top: 10px;
    }

    .bar-line {
      height: 10px;
      border-radius: 999px;
      background: #e3e3f5;
      overflow: hidden;
    }

    body.dark .bar-line {
      background: #252544;
    }

    .bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent-soft), var(--accent));
      transition: width 0.2s;
    }

    /* TABLES */

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      margin-top: 4px;
    }

    th, td {
      padding: 4px 3px;
      text-align: left;
      border-bottom: 1px solid #f0f0ff;
    }

    body.dark th, body.dark td {
      border-bottom-color: #2c2c45;
    }

    th {
      color: var(--text-soft);
      font-size: 0.7rem;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #f3f1ff;
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .tag.green {
      background: #e3f8ed;
      color: var(--success);
    }

    .tag.orange {
      background: #ffece3;
      color: #ff8a4a;
    }

    .tag.gray {
      background: #e5e5f5;
      color: var(--text-soft);
    }

    body.dark .tag {
      background: #2a2942;
    }
    body.dark .tag.gray {
      background: #343454;
    }

    /* CALEND√ÅRIO */

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 4px 0 6px;
    }

    .calendar-header span {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .cal-nav {
      display: flex;
      gap: 4px;
    }

    .icon-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f5f5ff;
      width: 26px;
      height: 26px;
      font-size: 0.7rem;
      cursor: pointer;
    }

    body.dark .icon-btn {
      background: #23233a;
      border-color: #34345a;
      color: #ddd;
    }

    .weekday-row {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      font-size: 0.7rem;
      color: var(--text-soft);
      margin-bottom: 3px;
      text-align: center;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }

    .day {
      aspect-ratio: 0.8 / 1;
      border-radius: 12px;
      background: #f5f5ff;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-soft);
      cursor: pointer;
      position: relative;
    }

    .day.empty {
      background: transparent;
      cursor: default;
    }

    .day.has {
      background: #e7e2ff;
      color: var(--text-main);
    }

    .day.today {
      border: 1px solid var(--accent);
    }

    .day.selected {
      background: var(--accent);
      color: #fff;
    }

    body.dark .day {
      background: #20203a;
    }
    body.dark .day.has {
      background: #34345a;
    }

    .note {
      font-size: 0.75rem;
      color: var(--text-soft);
      margin-top: 4px;
    }

    @media (min-width: 860px) {
      .grid-2 {
        display: grid;
        grid-template-columns: minmax(0,1.1fr) minmax(0,1fr);
        gap: 10px;
      }
    }

    .backup-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .backup-actions button {
      margin-top: 0;
      flex: 1;
    }

    @media print {
      .tabs,
      .theme-btn,
      #events-day-card,
      #debts-add-card,
      .backup-actions #btn-restore {
        display: none !important;
      }
      body {
        background: #ffffff;
      }
      .card {
        box-shadow: none;
        border-radius: 0;
        border: 1px solid #ddd;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="header-left">
        <div class="logo">CP</div>
        <div class="title-block">
          <h1>Painel Prestes</h1>
          <p>Fluxo de d√≠vidas e eventos em modo lil√°s clean & dark.</p>
        </div>
      </div>
      <button class="theme-btn" id="theme-toggle">üåô modo noite</button>
    </header>

    <nav class="tabs">
      <button class="tab-btn active" data-tab="dash">Dashboard</button>
      <button class="tab-btn" data-tab="debts">D√≠vidas</button>
      <button class="tab-btn" data-tab="events">Eventos</button>
    </nav>

    <!-- DASHBOARD -->
    <section id="dash" class="tab-panel active">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Resumo do m√™s</div>
            <div class="card-sub">Eventos e d√≠vidas consolidados.</div>
          </div>
          <div>
            <label for="dash-month">M√™s:</label>
            <input type="month" id="dash-month" />
          </div>
        </div>

        <!-- Linha 1: Eventos -->
        <div class="summary-grid">
          <div class="summary-item">
            <div class="summary-label">Eventos: total contratado</div>
            <div class="summary-value" id="dash-total">R$ 0,00</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Eventos: recebido</div>
            <div class="summary-value green" id="dash-recebido">R$ 0,00</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Eventos: falta receber</div>
            <div class="summary-value red" id="dash-falta">R$ 0,00</div>
          </div>
        </div>

        <!-- Linha 2: D√≠vidas -->
        <div class="summary-grid" style="margin-top:10px;">
          <div class="summary-item">
            <div class="summary-label">D√≠vidas do m√™s (todas)</div>
            <div class="summary-value red" id="dash-debts-total">R$ 0,00</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">D√≠vidas pendentes</div>
            <div class="summary-value red" id="dash-debts-pend">R$ 0,00</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Saldo l√≠quido (recebido - d√≠vidas pendentes)</div>
            <div class="summary-value" id="dash-liquid">R$ 0,00</div>
          </div>
        </div>

        <div class="bar-wrap">
          <div class="summary-label">Percentual recebido sobre eventos</div>
          <div class="bar-line">
            <div class="bar-fill" id="dash-bar"></div>
          </div>
        </div>

        <button id="btn-pdf" style="margin-top:10px;">üßæ Gerar PDF / impress√£o do m√™s</button>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Backup & Restaurar</div>
            <div class="card-sub">Salva tudo em arquivo .json.</div>
          </div>
        </div>
        <div class="backup-actions">
          <button class="secondary" id="btn-backup">üì¶ Backup</button>
          <button class="secondary" id="btn-restore">‚ôªÔ∏è Restaurar</button>
        </div>
        <input type="file" id="restore-file" accept=".json,application/json" style="display:none" />
        <p class="note">
          O backup inclui d√≠vidas (com status pago) e eventos (incluindo recebidos/parcial).
        </p>
      </div>
    </section>

    <!-- D√çVIDAS -->
    <section id="debts" class="tab-panel">
      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">D√≠vidas do m√™s</div>
              <div class="card-sub">√önicas, parceladas e recorrentes, com status de pagamento.</div>
            </div>
            <div>
              <label for="debts-month">M√™s:</label>
              <input type="month" id="debts-month" />
            </div>
          </div>

          <div class="summary-grid">
            <div class="summary-item">
              <div class="summary-label">Total (todas)</div>
              <div class="summary-value red" id="debts-total">R$ 0,00</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Pendente (n√£o pagas)</div>
              <div class="summary-value red" id="debts-pendente">R$ 0,00</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Qtd. lan√ßamentos</div>
              <div class="summary-value" id="debts-count">0</div>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Descri√ß√£o</th>
                <th>Valor</th>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="debts-table-body"></tbody>
          </table>
        </div>

        <div class="card" id="debts-add-card">
          <div class="card-header">
            <div>
              <div class="card-title">Adicionar d√≠vida</div>
              <div class="card-sub">Com op√ß√£o de parcelas, recorr√™ncia e pago.</div>
            </div>
          </div>

          <label for="d-nome">Nome</label>
          <input id="d-nome" type="text" placeholder="Ex: Cart√£o Nubank" />

          <label for="d-desc">Descri√ß√£o</label>
          <input id="d-desc" type="text" placeholder="Ex: Fatura dezembro" />

          <div class="row">
            <div>
              <label for="d-valor">Valor (por parcela ou total)</label>
              <input id="d-valor" type="number" step="0.01" placeholder="Ex: 400" />
            </div>
            <div>
              <label for="d-parcelas">Parcelas</label>
              <input id="d-parcelas" type="number" min="1" placeholder="Ex: 6" />
            </div>
          </div>

          <div class="checkbox-line">
            <input id="d-recorrente" type="checkbox" />
            <label for="d-recorrente">D√≠vida recorrente (repete por 12 meses)</label>
          </div>

          <div class="checkbox-line">
            <input id="d-pago" type="checkbox" />
            <label for="d-pago">J√° est√° paga</label>
          </div>

          <button id="btn-add-debt">Adicionar d√≠vida</button>

          <p class="note">
            ‚Ä¢ Com parcelas: cria 1/n, 2/n... m√™s a m√™s.<br />
            ‚Ä¢ Com recorrente (sem parcelas): replica a mesma d√≠vida por 12 meses.<br />
            ‚Ä¢ O status "pago" pode ser alternado depois na tabela.
          </p>
        </div>
      </div>
    </section>

    <!-- EVENTOS -->
    <section id="events" class="tab-panel">
      <div class="grid-2">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Calend√°rio de eventos</div>
              <div class="card-sub">Clique no dia para lan√ßar corridas.</div>
            </div>
            <div>
              <label for="events-month">M√™s:</label>
              <input type="month" id="events-month" />
            </div>
          </div>

          <div class="calendar-header">
            <span id="events-month-label"></span>
            <div class="cal-nav">
              <button class="icon-btn" id="cal-prev">&lt;</button>
              <button class="icon-btn" id="cal-next">&gt;</button>
            </div>
          </div>

          <div class="weekday-row">
            <div>Dom</div>
            <div>Seg</div>
            <div>Ter</div>
            <div>Qua</div>
            <div>Qui</div>
            <div>Sex</div>
            <div>S√°b</div>
          </div>

          <div id="calendar-grid" class="calendar-grid"></div>
        </div>

        <div class="card" id="events-day-card">
          <div class="card-header">
            <div>
              <div class="card-title" id="events-day-title">Selecione um dia</div>
              <div class="card-sub">Empresa, servi√ßo, valor, recebido e pago.</div>
            </div>
          </div>

          <div id="events-form-wrapper" style="display:none;">
            <label for="ev-empresa">Empresa</label>
            <input id="ev-empresa" type="text" placeholder="Ex: Foco Radical" />

            <label for="ev-servico">Servi√ßo</label>
            <input id="ev-servico" type="text" placeholder="Ex: Corrida 5km" />

            <div class="row">
              <div>
                <label for="ev-valor">Valor total</label>
                <input id="ev-valor" type="number" step="0.01" placeholder="Ex: 400" />
              </div>
              <div>
                <label for="ev-recebido">Recebido</label>
                <input id="ev-recebido" type="number" step="0.01" placeholder="Ex: 200" />
              </div>
            </div>

            <div class="checkbox-line">
              <input id="ev-pago" type="checkbox" />
              <label for="ev-pago">Pago total (considerar tudo recebido)</label>
            </div>

            <label for="ev-obs">Observa√ß√µes</label>
            <textarea id="ev-obs" placeholder="Ex: Pix na hora, restante depois."></textarea>

            <button id="btn-add-event">Adicionar evento</button>
          </div>

          <p class="note" id="events-empty">Clique em um dia no calend√°rio para lan√ßar evento.</p>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Eventos do m√™s</div>
            <div class="card-sub">Resumo das corridas e ensaios.</div>
          </div>
        </div>

        <div class="summary-grid">
          <div class="summary-item">
            <div class="summary-label">Qtd. eventos</div>
            <div class="summary-value" id="ev-count">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Total contratado</div>
            <div class="summary-value" id="ev-total">R$ 0,00</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Recebido</div>
            <div class="summary-value green" id="ev-recebido-total">R$ 0,00</div>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Empresa</th>
              <th>Servi√ßo</th>
              <th>Valor</th>
              <th>Recebido</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="events-table-body"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // ---------- helpers ----------
    const load = (key, fallback) => {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      } catch {
        return fallback;
      }
    };
    const save = (key, value) => localStorage.setItem(key, JSON.stringify(value));

    let debts = load("pp_debts", []);
    let events = load("pp_events", []);
    let selectedDate = null; // YYYY-MM-DD

    const money = v =>
      "R$ " + (v || 0).toFixed(2).replace(".", ",").replace(/\B(?=(\d{3})+(?!\d))/g, ".");

    const today = new Date();
    const defaultMonth =
      today.getFullYear() + "-" + String(today.getMonth() + 1).padStart(2, "0");

    const dashMonthInput = document.getElementById("dash-month");
    const debtsMonthInput = document.getElementById("debts-month");
    const eventsMonthInput = document.getElementById("events-month");

    dashMonthInput.value = defaultMonth;
    debtsMonthInput.value = defaultMonth;
    eventsMonthInput.value = defaultMonth;

    // ---------- theme toggle ----------
    const themeToggle = document.getElementById("theme-toggle");
    const savedTheme = load("pp_theme", "light");
    if (savedTheme === "dark") {
      document.body.classList.add("dark");
      themeToggle.textContent = "‚òÄ modo claro";
    }

    themeToggle.addEventListener("click", () => {
      const isDark = document.body.classList.toggle("dark");
      if (isDark) {
        themeToggle.textContent = "‚òÄ modo claro";
        save("pp_theme", "dark");
      } else {
        themeToggle.textContent = "üåô modo noite";
        save("pp_theme", "light");
      }
    });

    // ---------- tabs ----------
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
        btn.classList.add("active");
        const tabId = btn.dataset.tab;
        document.getElementById(tabId).classList.add("active");
      });
    });

    // ---------- d√≠vidas ----------
    const debtsTableBody = document.getElementById("debts-table-body");
    const debtsTotalEl = document.getElementById("debts-total");
    const debtsPendEl = document.getElementById("debts-pendente");
    const debtsCountEl = document.getElementById("debts-count");

    function renderDebts() {
      const mk = debtsMonthInput.value;
      const monthDebts = debts.filter(d => d.month === mk);

      debtsTableBody.innerHTML = "";
      let total = 0;
      let pendente = 0;

      monthDebts.forEach(d => {
        const isPago = !!d.pago;
        total += d.valor;
        if (!isPago) pendente += d.valor;

        const tr = document.createElement("tr");
        const statusTag = isPago
          ? "<span class='tag green'>Pago</span>"
          : "<span class='tag orange'>Pendente</span>";

        tr.innerHTML =
          "<td>" + d.nome + "</td>" +
          "<td>" + (d.desc || "") + "</td>" +
          "<td>" + money(d.valor) + "</td>" +
          "<td>" + statusTag + "</td>" +
          "<td></td>";

        const actionsTd = tr.lastElementChild;

        const btnToggle = document.createElement("button");
        btnToggle.className = "small secondary";
        btnToggle.textContent = isPago ? "Desfazer" : "Marcar pago";
        btnToggle.addEventListener("click", () => {
          d.pago = !d.pago;
          save("pp_debts", debts);
          renderDebts();
          renderDashboard();
        });

        const btnDelete = document.createElement("button");
        btnDelete.className = "small secondary";
        btnDelete.style.marginLeft = "4px";
        btnDelete.textContent = "Excluir";
        btnDelete.addEventListener("click", () => {
          debts = debts.filter(x => x.id !== d.id);
          save("pp_debts", debts);
          renderDebts();
          renderDashboard();
        });

        actionsTd.appendChild(btnToggle);
        actionsTd.appendChild(btnDelete);

        debtsTableBody.appendChild(tr);
      });

      debtsTotalEl.textContent = money(total);
      debtsPendEl.textContent = money(pendente);
      debtsCountEl.textContent = monthDebts.length;
    }

    function addDebt() {
      const nome = document.getElementById("d-nome").value.trim();
      const desc = document.getElementById("d-desc").value.trim();
      const valor = parseFloat(document.getElementById("d-valor").value || "0");
      const parcelas = parseInt(document.getElementById("d-parcelas").value || "0", 10);
      const recorrente = document.getElementById("d-recorrente").checked;
      const pagoInicial = document.getElementById("d-pago").checked;
      const mk = debtsMonthInput.value;

      if (!nome || !valor || !mk) return;

      const [yStr, mStr] = mk.split("-");
      const baseYear = Number(yStr);
      const baseMonth = Number(mStr); // 1-12

      const toAdd = [];
      const makeId = () =>
        (crypto.randomUUID && crypto.randomUUID()) ||
        (Date.now() + "-" + Math.random().toString(36).slice(2, 8));

      if (parcelas > 0) {
        for (let i = 0; i < parcelas; i++) {
          const d = new Date(baseYear, baseMonth - 1 + i, 1);
          const mKey = d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0");
          toAdd.push({
            id: makeId(),
            nome,
            desc,
            valor,
            month: mKey,
            recorrente: false,
            parcelaAtual: i + 1,
            parcelaTotal: parcelas,
            pago: pagoInicial
          });
        }
      } else if (recorrente) {
        for (let i = 0; i < 12; i++) {
          const d = new Date(baseYear, baseMonth - 1 + i, 1);
          const mKey = d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0");
          toAdd.push({
            id: makeId(),
            nome,
            desc,
            valor,
            month: mKey,
            recorrente: true,
            parcelaAtual: null,
            parcelaTotal: null,
            pago: pagoInicial
          });
        }
      } else {
        toAdd.push({
          id: makeId(),
          nome,
          desc,
          valor,
          month: mk,
          recorrente: false,
          parcelaAtual: null,
          parcelaTotal: null,
          pago: pagoInicial
        });
      }

      debts = debts.concat(toAdd);
      save("pp_debts", debts);

      document.getElementById("d-nome").value = "";
      document.getElementById("d-desc").value = "";
      document.getElementById("d-valor").value = "";
      document.getElementById("d-parcelas").value = "";
      document.getElementById("d-recorrente").checked = false;
      document.getElementById("d-pago").checked = false;

      renderDebts();
      renderDashboard();
    }

    document.getElementById("btn-add-debt").addEventListener("click", addDebt);
    debtsMonthInput.addEventListener("change", () => {
      renderDebts();
      renderDashboard();
    });

    // ---------- eventos ----------
    const eventsMonthLabel = document.getElementById("events-month-label");
    const calendarGrid = document.getElementById("calendar-grid");
    const eventsDayTitle = document.getElementById("events-day-title");
    const eventsFormWrapper = document.getElementById("events-form-wrapper");
    const eventsEmpty = document.getElementById("events-empty");
    const evCountEl = document.getElementById("ev-count");
    const evTotalEl = document.getElementById("ev-total");
    const evRecebidoTotalEl = document.getElementById("ev-recebido-total");
    const eventsTableBody = document.getElementById("events-table-body");

    function monthLabel(mk) {
      const [y, m] = mk.split("-");
      const d = new Date(Number(y), Number(m) - 1, 1);
      return d.toLocaleDateString("pt-BR", { month: "long", year: "numeric" });
    }

    function renderCalendar() {
      const mk = eventsMonthInput.value;
      const [yStr, mStr] = mk.split("-");
      const year = Number(yStr);
      const month = Number(mStr); // 1-12

      eventsMonthLabel.textContent = monthLabel(mk);

      const first = new Date(year, month - 1, 1);
      const firstDow = first.getDay(); // 0 dom
      const daysInMonth = new Date(year, month, 0).getDate();

      const todayStr =
        today.getFullYear() + "-" +
        String(today.getMonth() + 1).padStart(2, "0") + "-" +
        String(today.getDate()).padStart(2, "0");

      const hasEventByDay = {};
      events.forEach(ev => {
        const [y2, m2, d2] = ev.data.split("-");
        if (y2 + "-" + m2 === mk) {
          const day = Number(d2);
          hasEventByDay[day] = true;
        }
      });

      calendarGrid.innerHTML = "";

      for (let i = 0; i < firstDow; i++) {
        const div = document.createElement("div");
        div.className = "day empty";
        calendarGrid.appendChild(div);
      }

      for (let d = 1; d <= daysInMonth; d++) {
        const div = document.createElement("div");
        div.className = "day";
        div.textContent = d;

        const dateStr =
          year + "-" + String(month).padStart(2, "0") + "-" + String(d).padStart(2, "0");

        if (dateStr === todayStr) div.classList.add("today");
        if (hasEventByDay[d]) div.classList.add("has");
        if (selectedDate === dateStr) div.classList.add("selected");

        div.addEventListener("click", () => {
          selectedDate = dateStr;
          document.querySelectorAll(".day").forEach(day => day.classList.remove("selected"));
          div.classList.add("selected");

          eventsDayTitle.textContent = new Date(year, month - 1, d).toLocaleDateString("pt-BR", {
            weekday: "long",
            day: "2-digit",
            month: "long"
          });

          eventsFormWrapper.style.display = "block";
          eventsEmpty.style.display = "none";

          document.getElementById("ev-empresa").value = "";
          document.getElementById("ev-servico").value = "";
          document.getElementById("ev-valor").value = "";
          document.getElementById("ev-recebido").value = "";
          document.getElementById("ev-pago").checked = false;
          document.getElementById("ev-obs").value = "";
        });

        calendarGrid.appendChild(div);
      }
    }

    function renderEventsList() {
      const mk = eventsMonthInput.value;
      const monthEvents = events
        .filter(ev => ev.data.slice(0,7) === mk)
        .sort((a, b) => (a.data < b.data ? -1 : 1));

      eventsTableBody.innerHTML = "";
      let total = 0;
      let recebidoTotal = 0;

      monthEvents.forEach(ev => {
        total += ev.valor;
        recebidoTotal += ev.recebido || 0;

        const tr = document.createElement("tr");
        const isPago = !!ev.pago;
        const status = isPago
          ? "<span class='tag green'>Pago</span>"
          : ev.recebido > 0
          ? "<span class='tag orange'>Parcial</span>"
          : "<span class='tag gray'>Pendente</span>";

        tr.innerHTML =
          "<td>" + new Date(ev.data).toLocaleDateString("pt-BR") + "</td>" +
          "<td>" + (ev.empresa || "") + "</td>" +
          "<td>" + (ev.servico || "") + "</td>" +
          "<td>" + money(ev.valor) + "</td>" +
          "<td>" + money(ev.recebido || 0) + "</td>" +
          "<td>" + status + "</td>" +
          "<td></td>";

        const actionsTd = tr.lastElementChild;

        const btnToggle = document.createElement("button");
        btnToggle.className = "small secondary";
        btnToggle.textContent = isPago ? "Desfazer pago" : "Marcar pago";
        btnToggle.addEventListener("click", () => {
          if (ev.pago) {
            // desfazer: n√£o sabemos quanto era recebido antes, ent√£o zera e deixa como pendente
            ev.pago = false;
            ev.recebido = 0;
          } else {
            ev.pago = true;
            ev.recebido = ev.valor;
          }
          save("pp_events", events);
          renderEvents();
          renderDashboard();
        });

        const btnDelete = document.createElement("button");
        btnDelete.className = "small secondary";
        btnDelete.style.marginLeft = "4px";
        btnDelete.textContent = "Excluir";
        btnDelete.addEventListener("click", () => {
          events = events.filter(e => e.id !== ev.id);
          save("pp_events", events);
          renderEvents();
          renderDashboard();
        });

        actionsTd.appendChild(btnToggle);
        actionsTd.appendChild(btnDelete);

        eventsTableBody.appendChild(tr);
      });

      evCountEl.textContent = monthEvents.length;
      evTotalEl.textContent = money(total);
      evRecebidoTotalEl.textContent = money(recebidoTotal);
    }

    function renderEvents() {
      renderCalendar();
      renderEventsList();
    }

    function addEvent() {
      if (!selectedDate) return;

      const empresa = document.getElementById("ev-empresa").value.trim();
      const servico = document.getElementById("ev-servico").value.trim();
      const valor = parseFloat(document.getElementById("ev-valor").value || "0");
      let recebido = parseFloat(document.getElementById("ev-recebido").value || "0");
      const pago = document.getElementById("ev-pago").checked;
      const obs = document.getElementById("ev-obs").value.trim();

      if (!empresa || !valor) return;
      if (pago) recebido = valor;

      const makeId = () =>
        (crypto.randomUUID && crypto.randomUUID()) ||
        (Date.now() + "-" + Math.random().toString(36).slice(2,
