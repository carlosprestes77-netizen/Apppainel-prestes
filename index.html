<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel Financeiro • Prestes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-claro: #f3f4ff;
      --bg-card-claro: #ffffff;
      --bg-escuro: #050716;
      --bg-card-escuro: #101322;
      --texto-principal: #0f172a;
      --texto-secundario: #4b5563;
      --borda-suave: rgba(148, 163, 184, 0.4);
      --verde: #16a34a;
      --vermelho: #dc2626;
      --rosa: #ec4899;
      --roxo: #4f46e5;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    body[data-theme="claro"] {
      background: radial-gradient(circle at top, #e5e7ff 0, #f3f4ff 40%, #eef2ff 100%);
      color: var(--texto-principal);
    }

    body[data-theme="escuro"] {
      background: radial-gradient(circle at top, #1e1b4b 0, #020617 50%, #000 100%);
      color: #e5e7eb;
    }

    .app-shell {
      max-width: 960px;
      margin: 16px auto 40px;
      padding: 12px;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .badge-top {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.06);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .08em;
    }

    body[data-theme="escuro"] .badge-top {
      background: rgba(15, 23, 42, 0.7);
      color: #e5e7eb;
    }

    .dot-ok {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34,197,94,.2);
    }

    .toggle-tema-wrap {
      display: flex;
      justify-content: flex-end;
      flex: 1;
    }

    .toggle-tema {
      position: relative;
      width: 40px;
      height: 20px;
      border-radius: 999px;
      background: linear-gradient(120deg, var(--rosa), var(--roxo));
      cursor: pointer;
      padding: 2px;
      box-shadow: 0 0 0 1px rgba(148,163,184,0.6);
    }

    .toggle-knob {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: #f9fafb;
      transform: translateX(0);
      transition: transform .18s ease;
    }

    body[data-theme="escuro"] .toggle-knob {
      transform: translateX(18px);
    }

    h1 {
      margin-top: 10px;
      font-size: 24px;
      line-height: 1.2;
    }

    .subtitulo {
      margin-top: 6px;
      font-size: 14px;
      color: var(--texto-secundario);
      max-width: 600px;
    }

    body[data-theme="escuro"] .subtitulo {
      color: #9ca3af;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .tabs {
      display: inline-flex;
      gap: 6px;
      padding: 3px;
      border-radius: 999px;
      background: rgba(15,23,42,0.06);
    }

    body[data-theme="escuro"] .tabs {
      background: rgba(15,23,42,0.8);
    }

    .tab-btn {
      border: none;
      background: transparent;
      padding: 7px 16px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      color: var(--texto-secundario);
    }

    .tab-btn.active {
      background: linear-gradient(120deg, var(--roxo), var(--rosa));
      color: #fff;
      box-shadow: 0 8px 20px rgba(79,70,229,0.35);
    }

    .btn-pdf {
      border: none;
      background: transparent;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      cursor: pointer;
      border: 1px dashed rgba(148,163,184,0.9);
      color: var(--texto-secundario);
    }

    body[data-theme="escuro"] .btn-pdf {
      color: #e5e7eb;
      border-color: rgba(148,163,184,0.7);
    }

    .hint-storage {
      font-size: 11px;
      color: var(--texto-secundario);
      margin-top: 4px;
    }

    body[data-theme="escuro"] .hint-storage {
      color: #9ca3af;
    }

    .card-main {
      margin-top: 16px;
      background: rgba(255,255,255,0.96);
      border-radius: 24px;
      padding: 18px 14px 22px;
      box-shadow: 0 20px 50px rgba(15,23,42,0.16);
      border: 1px solid rgba(148,163,184,0.35);
    }

    body[data-theme="escuro"] .card-main {
      background: rgba(15,23,42,0.96);
      border-color: rgba(51,65,85,0.9);
    }

    .section {
      display: none;
      margin-top: 8px;
    }

    .section.active {
      display: block;
    }

    .sec-title-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .sec-title-row h2 {
      font-size: 18px;
    }

    .sec-title-row small {
      font-size: 12px;
      color: var(--texto-secundario);
    }

    body[data-theme="escuro"] .sec-title-row small {
      color: #9ca3af;
    }

    /* DASHBOARD QUADRADO */
    .dashboard-grid {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 12px;
    }

    .kpi-card {
      background: var(--bg-card-claro);
      border-radius: 16px;
      padding: 12px 12px 10px;
      border: 1px solid var(--borda-suave);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    body[data-theme="escuro"] .kpi-card {
      background: var(--bg-card-escuro);
      border-color: rgba(55,65,81,0.9);
    }

    .kpi-card h4 {
      font-size: 13px;
      margin: 0;
    }

    .kpi-valor {
      font-size: 18px;
      font-weight: 700;
    }

    .kpi-valor.verde { color: var(--verde); }
    .kpi-valor.vermelho { color: var(--vermelho); }
    .kpi-valor.neutro { color: var(--texto-principal); }
    body[data-theme="escuro"] .kpi-valor.neutro { color: #e5e7eb; }

    .kpi-sub {
      font-size: 11px;
      color: var(--texto-secundario);
    }

    body[data-theme="escuro"] .kpi-sub {
      color: #9ca3af;
    }

    /* LINHA DO TEMPO */
    .linha-tempo {
      margin-top: 16px;
      background: var(--bg-card-claro);
      border-radius: 16px;
      padding: 10px;
      border: 1px solid var(--borda-suave);
      max-height: 230px;
      overflow-y: auto;
    }

    body[data-theme="escuro"] .linha-tempo {
      background: var(--bg-card-escuro);
      border-color: rgba(55,65,81,0.9);
    }

    .linha-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding: 6px 6px;
      border-radius: 10px;
      font-size: 12px;
    }

    .linha-item:nth-child(odd) {
      background: rgba(148,163,184,0.12);
    }
    body[data-theme="escuro"] .linha-item:nth-child(odd) {
      background: rgba(31,41,55,0.9);
    }

    .linha-info strong {
      display: block;
      font-size: 12px;
    }

    .linha-info span {
      display: block;
      font-size: 11px;
      color: var(--texto-secundario);
    }

    body[data-theme="escuro"] .linha-info span {
      color: #9ca3af;
    }

    .tag-status {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid transparent;
    }

    .tag-status.pendente {
      color: #92400e;
      background: #fffbeb;
      border-color: #fbbf24;
    }

    .tag-status.parcial {
      color: #7c2d12;
      background: #fef3c7;
      border-color: #f97316;
    }

    .tag-status.pago {
      color: #166534;
      background: #ecfdf5;
      border-color: #22c55e;
    }

    body[data-theme="escuro"] .tag-status.pendente {
      background: rgba(250, 204, 21, .08);
      color: #facc15;
      border-color: rgba(250, 204, 21, .5);
    }
    body[data-theme="escuro"] .tag-status.parcial {
      background: rgba(249, 115, 22, .08);
      color: #fdba74;
      border-color: rgba(249, 115, 22, .5);
    }
    body[data-theme="escuro"] .tag-status.pago {
      background: rgba(34,197,94,.08);
      color: #4ade80;
      border-color: rgba(34,197,94,.5);
    }

    /* CALENDÁRIO */
    .calendario-wrap {
      margin-top: 12px;
      border-radius: 18px;
      background: var(--bg-card-claro);
      border: 1px solid var(--borda-suave);
      padding: 12px;
    }

    body[data-theme="escuro"] .calendario-wrap {
      background: var(--bg-card-escuro);
      border-color: rgba(55,65,81,0.7);
    }

    .cal-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .cal-nav button {
      background: transparent;
      border: none;
      color: var(--texto-secundario);
      font-size: 18px;
      cursor: pointer;
      padding: 4px 10px;
    }

    .cal-nav span {
      font-weight: 600;
      font-size: 16px;
    }

    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }

    .cal-header {
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      color: var(--texto-secundario);
      margin-bottom: 4px;
    }

    body[data-theme="escuro"] .cal-header {
      color: #9ca3af;
    }

    .dia {
      background: rgba(148,163,184,0.16);
      border-radius: 10px;
      padding: 6px;
      min-height: 62px;
      font-size: 12px;
      cursor: default;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: 4px;
    }

    body[data-theme="escuro"] .dia {
      background: rgba(51,65,85,0.6);
    }

    .dia-num {
      font-weight: 600;
      margin-bottom: 2px;
      font-size: 11px;
    }

    .evento-chip {
      background: linear-gradient(120deg, var(--roxo), var(--rosa));
      color: #fff;
      padding: 2px 6px;
      font-size: 10px;
      border-radius: 999px;
      display: inline-block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border: none;
      cursor: pointer;
    }

    /* FORMULÁRIOS / CAMPOS */
    .form-card {
      margin-top: 16px;
      background: var(--bg-card-claro);
      border: 1px solid var(--borda-suave);
      border-radius: 16px;
      padding: 14px;
    }

    body[data-theme="escuro"] .form-card {
      background: var(--bg-card-escuro);
      border-color: rgba(55,65,81,0.7);
    }

    .form-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 12px;
    }

    .form-row label {
      font-size: 12px;
      color: var(--texto-secundario);
      margin-bottom: 4px;
    }

    body[data-theme="escuro"] .form-row label {
      color: #9ca3af;
    }

    .form-row input,
    .form-row textarea,
    .form-row select {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--borda-suave);
      background: var(--bg-card-claro);
      color: inherit;
      font-size: 13px;
    }

    body[data-theme="escuro"] .form-row input,
    body[data-theme="escuro"] .form-row textarea,
    body[data-theme="escuro"] .form-row select {
      background: var(--bg-card-escuro);
      border-color: rgba(55,65,81,0.7);
    }

    .form-row textarea {
      resize: vertical;
      min-height: 48px;
    }

    .btn-salvar {
      border: none;
      padding: 10px 16px;
      border-radius: 12px;
      background: linear-gradient(120deg, var(--rosa), var(--roxo));
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 6px;
      width: 100%;
    }

    /* LISTA NA ABA DÍVIDAS */
    .lista-dividas {
      margin-top: 6px;
      background: var(--bg-card-claro);
      border: 1px solid var(--borda-suave);
      border-radius: 16px;
      padding: 10px;
      max-height: 270px;
      overflow-y: auto;
    }

    body[data-theme="escuro"] .lista-dividas {
      background: var(--bg-card-escuro);
      border-color: rgba(55,65,81,0.7);
    }

    .divida-item {
      padding: 8px;
      border-radius: 12px;
      background: rgba(148,163,184,0.15);
      margin-bottom: 8px;
      font-size: 12px;
    }

    body[data-theme="escuro"] .divida-item {
      background: rgba(51,65,85,0.6);
    }

    .divida-item strong {
      display:block;
      font-size:13px;
      margin-bottom:3px;
    }
  </style>
</head>
<body data-theme="claro">
  <div class="app-shell">
    <div class="header-row">
      <div class="badge-top">
        <span class="dot-ok"></span>
        <span>painel financeiro • prestes</span>
      </div>
      <div class="toggle-tema-wrap" onclick="toggleTema()">
        <div class="toggle-tema">
          <div class="toggle-knob"></div>
        </div>
      </div>
    </div>

    <h1>Eventos, dívidas e parcelas em modo profissional</h1>
    <p class="subtitulo">
      Uma tela pra cada lado da sua mente: dashboard, calendário de eventos e matriz de dívidas. Tudo salvo no seu navegador.
    </p>

    <div class="top-bar">
      <div class="tabs">
        <button class="tab-btn active" id="tab-dashboard" onclick="mudarAba('dashboard')">Dashboard</button>
        <button class="tab-btn" id="tab-eventos" onclick="mudarAba('eventos')">Eventos</button>
        <button class="tab-btn" id="tab-dividas" onclick="mudarAba('dividas')">Dívidas</button>
      </div>

      <button class="btn-pdf" onclick="exportarPDFCompleto()">
        Exportar PDF
      </button>
    </div>

    <p class="hint-storage">
      Dados salvos apenas no seu navegador (localStorage).
    </p>

    <div class="card-main">
      <!-- DASHBOARD -->
      <section id="sec-dashboard" class="section active">
        <div class="sec-title-row">
          <div>
            <h2>Visão geral</h2>
            <small>Receitas de eventos, dívidas do mês e fluxo líquido.</small>
          </div>
        </div>

        <div class="dashboard-grid">
          <div class="kpi-card">
            <h4>Receita confirmada (eventos pagos)</h4>
            <div id="dash-receita-confirmada" class="kpi-valor verde">R$ 0,00</div>
            <div id="dash-total-eventos" class="kpi-sub">Total em eventos: R$ 0,00</div>
          </div>

          <div class="kpi-card">
            <h4>Dívidas do mês</h4>
            <div id="dash-dividas-mes-total" class="kpi-valor vermelho">R$ 0,00</div>
            <div id="dash-dividas-mes-quitadas" class="kpi-sub">Quitadas neste mês: R$ 0,00</div>
            <div id="dash-dividas-geral-total" class="kpi-sub">Total geral (todas dívidas): R$ 0,00</div>
          </div>

          <div class="kpi-card">
            <h4>Eventos com pagamento parcial</h4>
            <div id="dash-eventos-parciais" class="kpi-valor neutro">0 evento(s)</div>
            <div id="dash-eventos-parciais-valor" class="kpi-sub">Valor potencial: R$ 0,00</div>
          </div>

          <div class="kpi-card">
            <h4>Dívidas em pagamento parcial</h4>
            <div id="dash-dividas-parciais" class="kpi-valor neutro">0 conta(s)</div>
            <div id="dash-dividas-parciais-valor" class="kpi-sub">Valor deste mês: R$ 0,00</div>
          </div>

          <div class="kpi-card">
            <h4>Fluxo líquido</h4>
            <div id="dash-fluxo-liquido" class="kpi-valor verde">R$ 0,00</div>
            <div class="kpi-sub">Receita confirmada – dívidas quitadas do mês.</div>
          </div>
        </div>

        <div class="linha-tempo">
          <div class="sec-title-row">
            <h3>Linha do tempo</h3>
            <small>Últimos eventos e dívidas cadastrados.</small>
          </div>
          <div id="linha-tempo-lista"></div>
        </div>
      </section>

      <!-- EVENTOS -->
      <section id="sec-eventos" class="section">
        <div class="sec-title-row">
          <h2>Eventos</h2>
          <small>Calendário + registro de eventos</small>
        </div>

        <div class="calendario-wrap">
          <div class="cal-nav">
            <button onclick="mesEventosAnterior()">&larr;</button>
            <span id="cal-mes-label">--/----</span>
            <button onclick="mesEventosProximo()">&rarr;</button>
          </div>

          <div id="cal-grid" class="cal-grid"></div>
        </div>

        <div class="form-card">
          <div class="sec-title-row">
            <h3>Novo evento</h3>
          </div>

          <div class="form-row">
            <label>Nome do evento / cliente</label>
            <input id="ev-nome" placeholder="Formatura, ensaio, aniversário..." />
          </div>

          <div class="form-row">
            <label>Empresa</label>
            <input id="ev-empresa" placeholder="Empresa, local ou referência" />
          </div>

          <div class="form-row">
            <label>Valor</label>
            <input id="ev-valor" type="number" placeholder="400, 800, 1500..." />
          </div>

          <div class="form-row">
            <label>Status</label>
            <select id="ev-status">
              <option value="pendente">Pendente</option>
              <option value="parcial">Parcial</option>
              <option value="pago">Pago</option>
            </select>
          </div>

          <div class="form-row">
            <label>Data do evento</label>
            <input id="ev-data" type="date" />
          </div>

          <div class="form-row">
            <label>Observações</label>
            <textarea id="ev-obs" rows="2" placeholder="Horário, local, detalhes..."></textarea>
          </div>

          <button class="btn-salvar" onclick="salvarEvento()">Salvar evento</button>
        </div>
      </section>

      <!-- DÍVIDAS -->
      <section id="sec-dividas" class="section">
        <div class="sec-title-row">
          <h2>Dívidas & Parcelados</h2>
          <small>Resumo do mês + controle geral</small>
        </div>

        <div class="dashboard-grid" style="margin-bottom:14px;">
          <div class="kpi-card">
            <h4>Total do mês (parcelas do mês)</h4>
            <div id="dividas-total-mes" class="kpi-valor vermelho">R$ 0,00</div>
          </div>

          <div class="kpi-card">
            <h4>Quitado neste mês</h4>
            <div id="dividas-quitado-mes" class="kpi-valor verde">R$ 0,00</div>
          </div>

          <div class="kpi-card">
            <h4>Total geral (todas dívidas)</h4>
            <div id="dividas-total-geral" class="kpi-valor neutro">R$ 0,00</div>
          </div>
        </div>

        <div class="lista-dividas" id="lista-dividas"></div>

        <div class="form-card" style="margin-top:16px;">
          <div class="sec-title-row">
            <h3>Nova dívida</h3>
          </div>

          <div class="form-row">
            <label>Conta / Descrição</label>
            <input id="dv-conta" placeholder="Cartão, câmera, luz..." />
          </div>

          <div class="form-row">
            <label>Valor total</label>
            <input id="dv-valor-total" type="number" placeholder="1200, 3000..." />
          </div>

          <div class="form-row">
            <label>Nº de parcelas</label>
            <input id="dv-parcelas" type="number" value="1" />
          </div>

          <div class="form-row">
            <label>Mês inicial</label>
            <input id="dv-mes-ref" type="month" />
          </div>

          <div class="form-row">
            <label>Observações</label>
            <textarea id="dv-obs" rows="2"></textarea>
          </div>

          <button class="btn-salvar" onclick="salvarDivida()">Salvar dívida</button>
        </div>
      </section>
    </div><!-- card-main -->
  </div><!-- app-shell -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const STORAGE_KEY = "painelFinanceiroPrestes-v4";

    const hoje = new Date();
    function criaMesObj(baseDate) {
      return { ano: baseDate.getFullYear(), mes: baseDate.getMonth() }; // 0-11
    }

    let state = {
      tema: "claro",
      aba: "dashboard",
      mesEventos: criaMesObj(hoje),
      mesDividas: criaMesObj(hoje),
      eventos: [],
      dividas: [] // cada parcela como item separado
    };

    const MESES = [
      "janeiro","fevereiro","março","abril","maio","junho",
      "julho","agosto","setembro","outubro","novembro","dezembro"
    ];

    function mesObjToTitulo(m) {
      return `${MESES[m.mes]} de ${m.ano}`;
    }

    function adicionarMes(m, delta) {
      let ano = m.ano;
      let mes = m.mes + delta;
      while (mes < 0) { mes += 12; ano--; }
      while (mes > 11) { mes -= 12; ano++; }
      return { ano, mes };
    }

    function mesKeyFromObj(m) {
      const mm = String(m.mes + 1).padStart(2, "0");
      return `${m.ano}-${mm}`;
    }

    function formatarMoeda(n) {
      return "R$ " + Number(n || 0).toFixed(2);
    }

    function parseDateStr(str) {
      if (!str || typeof str !== "string" || str.length < 10) return null;
      const [ano, mes, dia] = str.split("-").map(Number);
      if (!ano || !mes || !dia) return null;
      return { ano, mes: mes - 1, dia };
    }

    function carregarState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const salvo = JSON.parse(raw);
          state = { ...state, ...salvo };
        }
      } catch (e) {
        console.error("Erro ao carregar state", e);
      }
      aplicarTema();
    }

    function salvarState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function aplicarTema() {
      document.body.setAttribute("data-theme", state.tema || "claro");
    }

    function toggleTema() {
      state.tema = state.tema === "claro" ? "escuro" : "claro";
      aplicarTema();
      salvarState();
    }

    function mudarAba(aba) {
      state.aba = aba;
      document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));

      document.getElementById("sec-" + aba).classList.add("active");
      document.getElementById("tab-" + aba).classList.add("active");

      if (aba === "dashboard") renderDashboard();
      if (aba === "eventos") renderEventos();
      if (aba === "dividas") renderDividasMesCompleto();
    }

    // EVENTOS
    function salvarEvento() {
      const nome = document.getElementById("ev-nome").value.trim();
      const empresa = document.getElementById("ev-empresa").value.trim();
      const valor = parseFloat(document.getElementById("ev-valor").value || "0");
      const status = document.getElementById("ev-status").value;
      const data = document.getElementById("ev-data").value;
      const obs = document.getElementById("ev-obs").value.trim();

      if (!nome || !data) {
        alert("Preciso de pelo menos nome do evento e data.");
        return;
      }

      state.eventos.push({
        id: Date.now(),
        nome,
        empresa,
        valor,
        status,
        data,
        obs
      });

      salvarState();

      document.getElementById("ev-nome").value = "";
      document.getElementById("ev-empresa").value = "";
      document.getElementById("ev-valor").value = "";
      document.getElementById("ev-status").value = "pendente";
      document.getElementById("ev-data").value = "";
      document.getElementById("ev-obs").value = "";

      renderEventos();
      renderDashboard();
    }

    function eventosDoMes(mesObj) {
      const mes = mesObj.mes;
      const ano = mesObj.ano;
      return state.eventos.filter(ev => {
        const parsed = parseDateStr(ev.data);
        if (!parsed) return false;
        return parsed.mes === mes && parsed.ano === ano;
      });
    }

    function girarStatusEvento(id) {
      const ev = state.eventos.find(e => e.id === id);
      if (!ev) return;
      if (ev.status === "pendente") ev.status = "parcial";
      else if (ev.status === "parcial") ev.status = "pago";
      else ev.status = "pendente";
      salvarState();
      renderEventos();
      renderDashboard();
    }

    function mesEventosAnterior() {
      state.mesEventos = adicionarMes(state.mesEventos, -1);
      renderEventos();
    }

    function mesEventosProximo() {
      state.mesEventos = adicionarMes(state.mesEventos, 1);
      renderEventos();
    }

    function renderEventos() {
      const label = document.getElementById("cal-mes-label");
      if (label) label.textContent = mesObjToTitulo(state.mesEventos);

      const grid = document.getElementById("cal-grid");
      if (!grid) return;
      grid.innerHTML = "";

      const diasSemana = ["D", "S", "T", "Q", "Q", "S", "S"];
      diasSemana.forEach(d => {
        const h = document.createElement("div");
        h.className = "cal-header";
        h.textContent = d;
        grid.appendChild(h);
      });

      const primeiroDia = new Date(state.mesEventos.ano, state.mesEventos.mes, 1);
      const offset = primeiroDia.getDay();
      const diasNoMes = new Date(state.mesEventos.ano, state.mesEventos.mes + 1, 0).getDate();

      const eventosMes = eventosDoMes(state.mesEventos);

      for (let i = 0; i < offset; i++) {
        const vazio = document.createElement("div");
        grid.appendChild(vazio);
      }

      for (let dia = 1; dia <= diasNoMes; dia++) {
        const cell = document.createElement("div");
        cell.className = "dia";

        const num = document.createElement("div");
        num.className = "dia-num";
        num.textContent = dia;
        cell.appendChild(num);

        const diaStr = String(dia).padStart(2, "0");
        const mesStr = String(state.mesEventos.mes + 1).padStart(2, "0");
        const keyDia = `${state.mesEventos.ano}-${mesStr}-${diaStr}`;

        const eventosDia = eventosMes.filter(ev => ev.data === keyDia);
        eventosDia.forEach(ev => {
          const b = document.createElement("button");
          b.className = "evento-chip";
          b.textContent = (ev.nome || "Ev").slice(0, 8);
          b.title = `${ev.nome} • ${ev.empresa || ""} • ${formatarMoeda(ev.valor)} • ${ev.status}`;
          b.onclick = () => girarStatusEvento(ev.id);
          cell.appendChild(b);
        });

        grid.appendChild(cell);
      }
    }

    // DÍVIDAS
    function salvarDivida() {
      const conta = document.getElementById("dv-conta").value.trim();
      const valorTotal = parseFloat(document.getElementById("dv-valor-total").value || "0");
      let parcelas = parseInt(document.getElementById("dv-parcelas").value || "1");
      const mesRef = document.getElementById("dv-mes-ref").value;
      const obs = document.getElementById("dv-obs").value.trim();

      if (!conta || !valorTotal || !mesRef) {
        alert("Preciso de conta, valor total e mês inicial.");
        return;
      }
      if (parcelas < 1) parcelas = 1;

      const [anoStr, mesStr] = mesRef.split("-");
      let ano = parseInt(anoStr);
      let mes = parseInt(mesStr) - 1;

      const valorMensal = valorTotal / parcelas;

      for (let i = 0; i < parcelas; i++) {
        const m = adicionarMes({ ano, mes }, i);
        const mesReferencia = mesKeyFromObj(m);

        state.dividas.push({
          id: Date.now() + i,
          conta,
          valorTotal,
          parcelas,
          parcelaIndex: i + 1,
          valorMensal,
          mesReferencia,
          status: "pendente",
          obs
        });
      }

      salvarState();

      document.getElementById("dv-conta").value = "";
      document.getElementById("dv-valor-total").value = "";
      document.getElementById("dv-parcelas").value = "1";
      document.getElementById("dv-mes-ref").value = "";
      document.getElementById("dv-obs").value = "";

      renderDividasMesCompleto();
      renderDashboard();
    }

    function dividasDoMes(mesObj) {
      const key = mesKeyFromObj(mesObj);
      return state.dividas.filter(d => d.mesReferencia === key);
    }

    function girarStatusDivida(id) {
      const d = state.dividas.find(x => x.id === id);
      if (!d) return;
      if (d.status === "pendente") d.status = "parcial";
      else if (d.status === "parcial") d.status = "pago";
      else d.status = "pendente";
      salvarState();
      renderDividasMesCompleto();
      renderDashboard();
    }

    function calcularTotaisDividasMes(mesObj) {
      const divMes = dividasDoMes(mesObj);
      let totalMes = 0;
      let totalQuitado = 0;
      let totalParcial = 0;

      divMes.forEach(d => {
        const v = d.valorMensal || d.valorTotal;
        totalMes += v;
        if (d.status === "pago") totalQuitado += v;
        if (d.status === "parcial") totalParcial += v;
      });

      return { totalMes, totalQuitado, totalParcial };
    }

    function calcularTotalDividasGeral() {
      return state.dividas.reduce(
        (acc, d) => acc + (d.valorMensal || d.valorTotal || 0),
        0
      );
    }

    function renderDividasMesCompleto() {
      const tituloMes = mesObjToTitulo(state.mesDividas);
      // se quiser mostrar em algum lugar, dá pra usar título

      const lista = document.getElementById("lista-dividas");
      if (!lista) return;
      lista.innerHTML = "";

      const divMes = dividasDoMes(state.mesDividas);

      if (divMes.length === 0) {
        const vazio = document.createElement("p");
        vazio.className = "kpi-sub";
        vazio.textContent = "Nenhuma dívida cadastrada para este mês.";
        lista.appendChild(vazio);
      } else {
        divMes.forEach(d => {
          const item = document.createElement("div");
          item.className = "divida-item";

          const vMes = d.valorMensal || d.valorTotal;

          const titulo = document.createElement("strong");
          titulo.textContent = d.conta;
          item.appendChild(titulo);

          const linha1 = document.createElement("div");
          linha1.textContent =
            `Valor deste mês: ${formatarMoeda(vMes)} • Parcela ${d.parcelaIndex}/${d.parcelas}`;
          item.appendChild(linha1);

          const linha2 = document.createElement("div");
          linha2.textContent = `Total da dívida: ${formatarMoeda(d.valorTotal)}`;
          item.appendChild(linha2);

          if (d.obs) {
            const linhaObs = document.createElement("div");
            linhaObs.textContent = `Obs: ${d.obs}`;
            item.appendChild(linhaObs);
          }

          const statusBtn = document.createElement("button");
          statusBtn.className = "tag-status " + d.status;
          statusBtn.style.marginTop = "6px";
          statusBtn.textContent =
            d.status === "pendente"
              ? "Pendente"
              : d.status === "parcial"
              ? "Pago parcial"
              : "Quitado";
          statusBtn.onclick = () => girarStatusDivida(d.id);

          item.appendChild(statusBtn);

          lista.appendChild(item);
        });
      }

      const { totalMes, totalQuitado } = calcularTotaisDividasMes(state.mesDividas);
      const totalGeral = calcularTotalDividasGeral();

      document.getElementById("dividas-total-mes").textContent = formatarMoeda(totalMes);
      document.getElementById("dividas-quitado-mes").textContent = formatarMoeda(totalQuitado);
      document.getElementById("dividas-total-geral").textContent = formatarMoeda(totalGeral);

      // também refletir no dashboard
      document.getElementById("dash-dividas-mes-total").textContent = formatarMoeda(totalMes);
      document.getElementById("dash-dividas-mes-quitadas").textContent =
        "Quitadas neste mês: " + formatarMoeda(totalQuitado);
      document.getElementById("dash-dividas-geral-total").textContent =
        "Total geral (todas dívidas): " + formatarMoeda(totalGeral);
    }

    // Mudar mês de dívidas (usa o mesmo state.mesDividas da dashboard)
    // Se quiser navegar por mês de dívidas, dá pra adaptar depois

    // DASHBOARD
    function renderDashboard() {
      const totalEventos = state.eventos.reduce(
        (acc, ev) => acc + (ev.valor || 0),
        0
      );
      const eventosPagos = state.eventos.filter(e => e.status === "pago");
      const receitaConfirmada = eventosPagos.reduce(
        (acc, ev) => acc + (ev.valor || 0),
        0
      );

      const eventosParciais = state.eventos.filter(e => e.status === "parcial");
      const potencialParcial = eventosParciais.reduce(
        (acc, ev) => acc + (ev.valor || 0),
        0
      );

      const { totalMes, totalQuitado, totalParcial } =
        calcularTotaisDividasMes(state.mesDividas);
      const totalGeralDividas = calcularTotalDividasGeral();
      const divParciaisMes = dividasDoMes(state.mesDividas).filter(
        d => d.status === "parcial"
      );

      document.getElementById("dash-receita-confirmada").textContent =
        formatarMoeda(receitaConfirmada);
      document.getElementById("dash-total-eventos").textContent =
        "Total em eventos: " + formatarMoeda(totalEventos);

      document.getElementById("dash-eventos-parciais").textContent =
        `${eventosParciais.length} evento(s)`;
      document.getElementById("dash-eventos-parciais-valor").textContent =
        "Valor potencial: " + formatarMoeda(potencialParcial);

      document.getElementById("dash-dividas-mes-total").textContent =
        formatarMoeda(totalMes);
      document.getElementById("dash-dividas-mes-quitadas").textContent =
        "Quitadas neste mês: " + formatarMoeda(totalQuitado);
      document.getElementById("dash-dividas-geral-total").textContent =
        "Total geral (todas dívidas): " + formatarMoeda(totalGeralDividas);

      document.getElementById("dash-dividas-parciais").textContent =
        `${divParciaisMes.length} conta(s)`;
      document.getElementById("dash-dividas-parciais-valor").textContent =
        "Valor deste mês: " + formatarMoeda(totalParcial);

      const fluxoLiquido = receitaConfirmada - totalQuitado;
      document.getElementById("dash-fluxo-liquido").textContent =
        formatarMoeda(fluxoLiquido);

      renderLinhaTempo();
    }

    function renderLinhaTempo() {
      const cont = document.getElementById("linha-tempo-lista");
      if (!cont) return;
      cont.innerHTML = "";

      const itens = [];

      state.eventos.forEach(ev => {
        itens.push({
          tipo: "evento",
          data: ev.data || "",
          rotulo: ev.nome || "Evento",
          extra: ev.empresa || "",
          valor: ev.valor || 0,
          status: ev.status,
        });
      });

      state.dividas.forEach(d => {
        const data = d.mesReferencia ? d.mesReferencia + "-01" : "";
        itens.push({
          tipo: "divida",
          data,
          rotulo: d.conta || "Conta",
          extra:
            d.parcelas > 1
              ? `Parcela ${d.parcelaIndex}/${d.parcelas}`
              : "Dívida única",
          valor: d.valorMensal || d.valorTotal || 0,
          status: d.status,
        });
      });

      itens.sort((a, b) => (a.data > b.data ? -1 : a.data < b.data ? 1 : 0));
      const recorte = itens.slice(0, 20);

      if (recorte.length === 0) {
        const vazio = document.createElement("p");
        vazio.className = "kpi-sub";
        vazio.textContent = "Nada cadastrado ainda.";
        cont.appendChild(vazio);
        return;
      }

      recorte.forEach(it => {
        const linha = document.createElement("div");
        linha.className = "linha-item";

        const info = document.createElement("div");
        info.className = "linha-info";

        const s1 = document.createElement("strong");
        s1.textContent =
          (it.tipo === "evento" ? "Evento · " : "Dívida · ") + it.rotulo;
        info.appendChild(s1);

        const s2 = document.createElement("span");
        s2.textContent = `${it.extra || ""} ${
          it.data ? "· " + it.data : ""
        }`.trim();
        info.appendChild(s2);

        const valor = document.createElement("span");
        valor.className = "kpi-sub";
        valor.textContent = formatarMoeda(it.valor);
        info.appendChild(valor);

        const tag = document.createElement("div");
        tag.className = "tag-status " + it.status;
        tag.textContent =
          it.status === "pendente"
            ? "Pendente"
            : it.status === "parcial"
            ? "Pago parcial"
            : "Quitado";

        linha.appendChild(info);
        linha.appendChild(tag);
        cont.appendChild(linha);
      });
    }

    // PDF bonitinho
    function exportarPDFCompleto() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 16;

      function linha(txt, size = 11, cor = [0,0,0], indent = 10, bold = false) {
        doc.setFont("helvetica", bold ? "bold" : "normal");
        doc.setFontSize(size);
        doc.setTextColor(cor[0], cor[1], cor[2]);
        const linhas = doc.splitTextToSize(txt, 190 - indent);
        linhas.forEach(l => {
          if (y > 280) {
            doc.addPage();
            y = 16;
          }
          doc.text(l, indent, y);
          y += 5;
        });
      }

      function tituloPrincipal() {
        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.setTextColor(79, 70, 229); // roxo
        const txt = "Relatório financeiro • Prestes";
        const w = doc.getTextWidth(txt);
        doc.text(txt, (210 - w) / 2, y);
        y += 8;

        doc.setDrawColor(236, 72, 153); // rosa
        doc.setLineWidth(0.8);
        doc.line(20, y, 190, y);
        y += 8;
      }

      tituloPrincipal();

      const mesTitulo = mesObjToTitulo(state.mesDividas);
      const totMes = calcularTotaisDividasMes(state.mesDividas);
      const totalGeralDividas = calcularTotalDividasGeral();
      const totalEventos = state.eventos.reduce((a, e) => a + (e.valor || 0), 0);
      const eventosPagos = state.eventos.filter(e => e.status === "pago");
      const receitaConfirmada = eventosPagos.reduce(
        (a, e) => a + (e.valor || 0),
        0
      );

      linha("Mês de referência: " + mesTitulo, 12, [55,65,81], 10, true);
      linha("Resumo:", 12, [55,65,81], 10, true);
      linha("• Receita confirmada em eventos: " + formatarMoeda(receitaConfirmada), 11, [0,128,0], 14);
      linha("• Total em eventos (todos): " + formatarMoeda(totalEventos), 11, [0,0,0], 14);
      linha("• Dívidas do mês (parcelas deste mês): " + formatarMoeda(totMes.totalMes), 11, [178,34,34], 14);
      linha("• Quitadas neste mês: " + formatarMoeda(totMes.totalQuitado), 11, [22,163,74], 14);
      linha("• Em aberto neste mês: " + formatarMoeda(totMes.totalMes - totMes.totalQuitado), 11, [234,88,12], 14);
      linha("• Total geral de todas as dívidas (todas parcelas): " + formatarMoeda(totalGeralDividas), 11, [30,64,175], 14);

      y += 4;
      linha("EVENTOS", 13, [79,70,229], 10, true);
      doc.setDrawColor(79,70,229);
      doc.setLineWidth(0.4);
      doc.line(10, y, 70, y);
      y += 6;

      if (state.eventos.length === 0) {
        linha("Nenhum evento cadastrado.", 11, [107,114,128], 12);
      } else {
        const eventosOrdenados = state.eventos
          .slice()
          .sort((a, b) => (a.data > b.data ? 1 : -1));

        eventosOrdenados.forEach(ev => {
          linha(`• ${ev.nome || "Evento"} (${ev.data || "-"})`, 11, [0,0,0], 12, true);
          if (ev.empresa) linha(`Empresa / cliente: ${ev.empresa}`, 10, [75,85,99], 16);
          linha(`Valor: ${formatarMoeda(ev.valor || 0)} • Status: ${(ev.status || "pendente").toUpperCase()}`, 10, [55,65,81], 16);
          if (ev.obs) linha(`Obs: ${ev.obs}`, 10, [107,114,128], 16);
          y += 2;
        });
      }

      y += 4;
      linha("DÍVIDAS / PARCELADOS", 13, [236,72,153], 10, true);
      doc.setDrawColor(236,72,153);
      doc.setLineWidth(0.4);
      doc.line(10, y, 80, y);
      y += 6;

      if (state.dividas.length === 0) {
        linha("Nenhuma dívida cadastrada.", 11, [107,114,128], 12);
      } else {
        const divsOrdenadas = state.dividas
          .slice()
          .sort((a, b) =>
            a.mesReferencia > b.mesReferencia ? 1 : -1
          );

        divsOrdenadas.forEach(d => {
          const vMes = d.valorMensal || d.valorTotal;
          linha(
            `• ${d.conta || "Conta"} • mês: ${d.mesReferencia || "-"} • ${formatarMoeda(vMes)} (total: ${formatarMoeda(d.valorTotal)})`,
            11,
            [0,0,0],
            12,
            true
          );
          if (d.parcelas > 1)
            linha(
              `Parcela ${d.parcelaIndex}/${d.parcelas}`,
              10,
              [75,85,99],
              16
            );
          linha(
            `Status: ${(d.status || "pendente").toUpperCase()}`,
            10,
            d.status === "pago"
              ? [22,163,74]
              : d.status === "parcial"
              ? [234,88,12]
              : [178,34,34],
            16
          );
          if (d.obs) linha(`Obs: ${d.obs}`, 10, [107,114,128], 16);
          y += 2;
        });
      }

      doc.save("relatorio-financeiro-prestes.pdf");
    }

    // INIT
    carregarState();
    aplicarTema();
    renderEventos();
    renderDividasMesCompleto();
    renderDashboard();
  </script>
</body>
</html>
