<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel Financeiro • Prestes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-claro: #f3f4ff;
      --bg-card-claro: #ffffff;
      --bg-escuro: #050716;
      --bg-card-escuro: #101322;
      --roxo: #7b5cff;
      --rosa: #ff5ccd;
      --cinza-escuro: #111827;
      --texto-principal: #0f172a;
      --texto-secundario: #4b5563;
      --borda-suave: rgba(148, 163, 184, 0.4);
      --verde: #16a34a;
      --vermelho: #dc2626;
      --laranja: #f97316;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    body[data-theme="claro"] {
      background: radial-gradient(circle at top, #e5e7ff 0, #f3f4ff 40%, #eef2ff 100%);
      color: var(--texto-principal);
    }

    body[data-theme="escuro"] {
      background: radial-gradient(circle at top, #1e1b4b 0, #020617 50%, #000 100%);
      color: #e5e7eb;
    }

    .app-shell {
      max-width: 960px;
      margin: 16px auto 40px;
      padding: 12px;
    }

    .badge-top {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.06);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .08em;
    }

    body[data-theme="escuro"] .badge-top {
      background: rgba(15, 23, 42, 0.7);
      color: #e5e7eb;
    }

    .dot-ok {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34,197,94,.2);
    }

    h1 {
      margin-top: 12px;
      font-size: 24px;
      line-height: 1.2;
    }

    .subtitulo {
      margin-top: 6px;
      font-size: 14px;
      color: var(--texto-secundario);
      max-width: 600px;
    }

    body[data-theme="escuro"] .subtitulo {
      color: #9ca3af;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .toggle-tema {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px;
      border-radius: 999px;
      background: linear-gradient(120deg, #4f46e5, #ec4899);
      box-shadow: 0 12px 30px rgba(79,70,229,0.35);
      cursor: pointer;
    }

    .toggle-tema span {
      font-size: 12px;
      color: #e5e7eb;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.2);
    }

    .toggle-switch {
      position: relative;
      width: 42px;
      height: 22px;
      border-radius: 999px;
      background: rgba(15,23,42,0.8);
      padding: 3px;
    }

    .toggle-knob {
      width: 16px;
      height: 16px;
      background: #e5e7eb;
      border-radius: 999px;
      transition: transform .18s ease;
    }

    body[data-theme="claro"] .toggle-knob {
      transform: translateX(0);
    }

    body[data-theme="escuro"] .toggle-knob {
      transform: translateX(18px);
    }

    .tabs {
      margin-top: 18px;
      background: rgba(15,23,42,0.06);
      border-radius: 999px;
      padding: 4px;
      display: inline-flex;
      gap: 6px;
    }

    body[data-theme="escuro"] .tabs {
      background: rgba(15,23,42,0.85);
    }

    .tab-btn {
      border: none;
      background: transparent;
      border-radius: 999px;
      padding: 7px 18px;
      font-size: 14px;
      cursor: pointer;
      color: var(--texto-secundario);
      transition: background .18s ease, color .18s ease, transform .1s ease;
    }

    .tab-btn.active {
      background: linear-gradient(120deg, #4f46e5, #ec4899);
      color: white;
      box-shadow: 0 8px 20px rgba(79,70,229,0.4);
      transform: translateY(-1px);
    }

    .card-main {
      margin-top: 18px;
      background: rgba(255,255,255,0.9);
      border-radius: 28px;
      padding: 18px 16px 24px;
      box-shadow: 0 20px 60px rgba(15,23,42,0.15);
      border: 1px solid rgba(148,163,184,0.35);
    }

    body[data-theme="escuro"] .card-main {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(51,65,85,0.8);
    }

    .hint-storage {
      font-size: 11px;
      color: var(--texto-secundario);
      margin-top: 4px;
    }

    body[data-theme="escuro"] .hint-storage {
      color: #9ca3af;
    }

    .section {
      margin-top: 18px;
      display: none;
    }

    .section.active {
      display: block;
    }

    .sec-title-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .sec-title-row h2 {
      font-size: 18px;
    }

    .sec-title-row small {
      font-size: 12px;
      color: var(--texto-secundario);
    }

    .grid-visao {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      .grid-visao {
        grid-template-columns: 1fr;
      }
    }

    .card-small {
      background: var(--bg-card-claro);
      border-radius: 16px;
      padding: 12px 12px 10px;
      border: 1px solid var(--borda-suave);
    }

    body[data-theme="escuro"] .card-small {
      background: var(--bg-card-escuro);
      border-color: rgba(55,65,81,0.8);
    }

    .card-small h3, .card-small h4 {
      margin-bottom: 4px;
      font-size: 13px;
    }

    .valor-ok {
      color: var(--verde);
      font-weight: 700;
      font-size: 18px;
    }

    .valor-bad {
      color: var(--vermelho);
      font-weight: 700;
      font-size: 18px;
    }

    .valor-neutro {
      color: var(--texto-principal);
      font-weight: 700;
      font-size: 18px;
    }

    body[data-theme="escuro"] .valor-neutro {
      color: #e5e7eb;
    }

    .texto-menor {
      font-size: 11px;
      color: var(--texto-secundario);
    }

    body[data-theme="escuro"] .texto-menor {
      color: #9ca3af;
    }

    .linha-tempo {
      margin-top: 14px;
      background: var(--bg-card-claro);
      border-radius: 16px;
      padding: 10px;
      border: 1px solid var(--borda-suave);
      max-height: 240px;
      overflow-y: auto;
    }

    body[data-theme="escuro"] .linha-tempo {
      background: var(--bg-card-escuro);
      border-color: rgba(55,65,81,0.8);
    }

    .linha-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding: 7px 6px;
      border-radius: 10px;
      font-size: 12px;
    }

    .linha-item:nth-child(odd) {
      background: rgba(148,163,184,0.09);
    }
    body[data-theme="escuro"] .linha-item:nth-child(odd) {
      background: rgba(31,41,55,0.9);
    }

    .linha-info strong {
      display: block;
      font-size: 12px;
    }

    .linha-info span {
      display: block;
      font-size: 11px;
      color: var(--texto-secundario);
    }

    body[data-theme="escuro"] .linha-info span {
      color: #9ca3af;
    }

    .tag-status {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid transparent;
    }

    .tag-status.pendente {
      color: #92400e;
      background: #fffbeb;
      border-color: #fbbf24;
    }

    .tag-status.parcial {
      color: #7c2d12;
      background: #fef3c7;
      border-color: #f97316;
    }

    .tag-status.pago {
      color: #166534;
      background: #ecfdf5;
      border-color: #22c55e;
    }

    body[data-theme="escuro"] .tag-status.pendente {
      background: rgba(250, 204, 21, .08);
      color: #facc15;
      border-color: rgba(250, 204, 21, .5);
    }
    body[data-theme="escuro"] .tag-status.parcial {
      background: rgba(249, 115, 22, .08);
      color: #fdba74;
      border-color: rgba(249, 115, 22, .5);
    }
    body[data-theme="escuro"] .tag-status.pago {
      background: rgba(34,197,94,.08);
      color: #4ade80;
      border-color: rgba(34,197,94,.5);
    }

    .btn-pdf {
      border: none;
      background: transparent;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      cursor: pointer;
      border: 1px dashed rgba(148,163,184,0.8);
      color: var(--texto-secundario);
    }

    body[data-theme="escuro"] .btn-pdf {
      color: #e5e7eb;
      border-color: rgba(148,163,184,0.6);
    }

    .btn-pdf:hover {
      border-style: solid;
    }

    .calendar-shell {
      margin-top: 10px;
      background: var(--bg-card-claro);
      border-radius: 18px;
      padding: 12px;
      border: 1px solid var(--borda-suave);
    }

    body[data-theme="escuro"] .calendar-shell {
      background: var(--bg-card-escuro);
      border-color: rgba(55,65,81,0.8);
    }

    .month-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .month-header h3 {
      font-size: 16px;
    }

    .month-nav-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: transparent;
      width: 26px;
      height: 26px;
      font-size: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    body[data-theme="escuro"] .month-nav-btn {
      border-color: rgba(148,163,184,0.8);
      color: #e5e7eb;
      background: rgba(15,23,42,0.6);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
      font-size: 11px;
    }

    .cal-header {
      text-align: center;
      font-weight: 600;
      color: var(--texto-secundario);
      margin-bottom: 4px;
    }

    body[data-theme="escuro"] .cal-header {
      color: #9ca3af;
    }

    .cal-cell {
      min-height: 52px;
      border-radius: 12px;
      padding: 3px 3px 4px;
      background: rgba(148,163,184,0.15);
      position: relative;
      overflow: hidden;
    }

    body[data-theme="escuro"] .cal-cell {
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(55,65,81,0.9);
    }

    .cal-day-num {
      font-size: 10px;
      opacity: .7;
      margin-bottom: 2px;
    }

    .cal-badges {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .cal-badge {
      border-radius: 999px;
      padding: 2px 4px;
      font-size: 9px;
      background: #4f46e5;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .form-shell {
      margin-top: 14px;
      background: var(--bg-card-claro);
      border-radius: 18px;
      padding: 12px;
      border: 1px solid var(--borda-suave);
    }

    body[data-theme="escuro"] .form-shell {
      background: var(--bg-card-escuro);
      border-color: rgba(55,65,81,0.8);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 12px;
    }

    .field label {
      font-size: 11px;
      color: var(--texto-secundario);
    }

    body[data-theme="escuro"] .field label {
      color: #9ca3af;
    }

    .field input,
    .field select,
    .field textarea {
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.8);
      padding: 6px 8px;
      font-size: 13px;
      background: rgba(255,255,255,0.95);
    }

    body[data-theme="escuro"] .field input,
    body[data-theme="escuro"] .field select,
    body[data-theme="escuro"] .field textarea {
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      border-color: rgba(75,85,99,0.9);
    }

    .field textarea {
      resize: vertical;
      min-height: 40px;
    }

    .btn-primary {
      margin-top: 8px;
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 13px;
      cursor: pointer;
      background: linear-gradient(120deg, #4f46e5, #ec4899);
      color: white;
      box-shadow: 0 12px 30px rgba(79,70,229,0.35);
    }

    .resumo-dividas-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 8px;
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      .resumo-dividas-grid {
        grid-template-columns: 1fr;
      }
    }

    .card-resumo-divida {
      background: var(--bg-card-claro);
      border-radius: 14px;
      padding: 8px 10px;
      border: 1px solid var(--borda-suave);
      font-size: 12px;
    }

    body[data-theme="escuro"] .card-resumo-divida {
      background: var(--bg-card-escuro);
      border-color: rgba(55,65,81,0.8);
    }

    .card-resumo-divida h4 {
      font-size: 12px;
      margin-bottom: 3px;
    }

    .card-resumo-divida .valor {
      font-size: 16px;
      font-weight: 700;
    }

    .lista-dividas {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .divida-card {
      padding: 8px 10px;
      border-radius: 14px;
      background: var(--bg-card-claro);
      border: 1px solid var(--borda-suave);
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
    }

    body[data-theme="escuro"] .divida-card {
      background: var(--bg-card-escuro);
      border-color: rgba(55,65,81,0.8);
    }

    .divida-main strong {
      display: block;
      font-size: 13px;
    }

    .divida-main span {
      display: block;
      font-size: 11px;
      color: var(--texto-secundario);
    }

    body[data-theme="escuro"] .divida-main span {
      color: #9ca3af;
    }

    .divida-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }

    .btn-status {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: transparent;
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
    }

    body[data-theme="escuro"] .btn-status {
      color: #e5e7eb;
      border-color: rgba(148,163,184,0.7);
    }
  </style>
</head>
<body data-theme="claro">
  <div class="app-shell">
    <div class="badge-top">
      <span class="dot-ok"></span>
      <span>PAINEL FINANCEIRO • PRESTES</span>
    </div>

    <h1>Eventos, dívidas e parcelas em modo profissional</h1>
    <p class="subtitulo">
      Uma tela para cada lado da sua mente: dashboard, calendário de eventos e matriz de dívidas. Tudo salvo no seu navegador.
    </p>

    <div class="top-row">
      <div class="toggle-tema" onclick="toggleTema()">
        <span id="label-tema">Modo claro ativo</span>
        <div class="toggle-switch">
          <div class="toggle-knob"></div>
        </div>
      </div>

      <button class="btn-pdf" onclick="exportarPDFCompleto()">
        Exportar PDF
      </button>
    </div>

    <p class="hint-storage">
      Dados guardados no seu navegador (localStorage).
    </p>

    <div class="tabs">
      <button class="tab-btn active" id="tab-dashboard" onclick="mudarAba('dashboard')">Dashboard</button>
      <button class="tab-btn" id="tab-eventos" onclick="mudarAba('eventos')">Eventos</button>
      <button class="tab-btn" id="tab-dividas" onclick="mudarAba('dividas')">Dívidas</button>
    </div>

    <div class="card-main">
      <!-- DASHBOARD -->
      <section id="sec-dashboard" class="section active">
        <div class="sec-title-row">
          <div>
            <h2>Visão geral</h2>
            <small>Eventos fechados, dívidas e fluxo confirmado.</small>
          </div>
        </div>

        <div class="grid-visao">
          <div class="card-small">
            <h4>Receita confirmada (eventos pagos)</h4>
            <p id="dash-receita-confirmada" class="valor-ok">R$ 0,00</p>
            <p id="dash-total-eventos" class="texto-menor">Total em eventos: R$ 0,00</p>
          </div>

          <div class="card-small">
            <h4>Dívidas do mês</h4>
            <p id="dash-dividas-mes-total" class="valor-bad">R$ 0,00</p>
            <p id="dash-dividas-mes-quitadas" class="texto-menor">
              Quitadas neste mês: R$ 0,00
            </p>
            <p id="dash-dividas-geral-total" class="texto-menor">
              Total geral (todas dívidas): R$ 0,00
            </p>
          </div>

          <div class="card-small">
            <h4>Eventos com pagamento parcial</h4>
            <p id="dash-eventos-parciais" class="valor-neutro">0 evento(s)</p>
            <p id="dash-eventos-parciais-valor" class="texto-menor">Valor potencial: R$ 0,00</p>
          </div>

          <div class="card-small">
            <h4>Dívidas em pagamento parcial</h4>
            <p id="dash-dividas-parciais" class="valor-neutro">0 conta(s)</p>
            <p id="dash-dividas-parciais-valor" class="texto-menor">Valor deste mês: R$ 0,00</p>
          </div>

          <div class="card-small">
            <h4>Fluxo líquido</h4>
            <p id="dash-fluxo-liquido" class="valor-ok">R$ 0,00</p>
            <p class="texto-menor">Receita confirmada – dívidas quitadas no mês.</p>
          </div>
        </div>

        <div class="linha-tempo">
          <div class="sec-title-row">
            <h3>Linha do tempo rápida</h3>
            <small>Últimos eventos e dívidas cadastrados.</small>
          </div>
          <div id="linha-tempo-lista"></div>
        </div>
      </section>
            <!-- EVENTOS -->
      <section id="sec-eventos" class="section">
        <div class="sec-title-row">
          <div>
            <h2>Eventos</h2>
            <small>Calendário mensal com eventos, empresas e status de pagamento.</small>
          </div>
        </div>

        <div class="calendar-shell">
          <div class="month-header">
            <div>
              <h3 id="titulo-mes-eventos">Mês de referência</h3>
              <small class="texto-menor">
                Toque no chip do evento para girar o status: pendente → parcial → pago.
              </small>
            </div>
            <div>
              <button class="month-nav-btn" onclick="mudarMesEventos(-1)">‹</button>
              <button class="month-nav-btn" onclick="mudarMesEventos(1)">›</button>
            </div>
          </div>

          <div class="calendar-grid" id="grid-eventos"></div>
        </div>

        <div class="form-shell">
          <div class="sec-title-row">
            <h3>Novo evento</h3>
            <small>Campos básicos: evento, empresa, valor, forma, observação.</small>
          </div>

          <div class="form-grid">
            <div class="field">
              <label for="ev-nome">Nome / tipo do evento</label>
              <input id="ev-nome" type="text" placeholder="Pré evento, casamento, formatura..." />
            </div>

            <div class="field">
              <label for="ev-empresa">Empresa / cliente</label>
              <input id="ev-empresa" type="text" placeholder="Euphoria, Colégio X..." />
            </div>

            <div class="field">
              <label for="ev-data">Data</label>
              <input id="ev-data" type="date" />
            </div>

            <div class="field">
              <label for="ev-valor">Valor (R$)</label>
              <input id="ev-valor" type="number" step="0.01" min="0" placeholder="350, 1200..." />
            </div>

            <div class="field">
              <label for="ev-forma">Forma de pagamento</label>
              <input id="ev-forma" type="text" placeholder="Pix, cartão, boleto..." />
            </div>

            <div class="field">
              <label for="ev-obs">Observação</label>
              <textarea id="ev-obs" placeholder="Pré evento do casamento da fulana, combinado 30% agora..."></textarea>
            </div>
          </div>

          <button class="btn-primary" onclick="salvarEvento()">Salvar evento</button>
        </div>
      </section>

      <!-- DÍVIDAS -->
      <section id="sec-dividas" class="section">
        <div class="sec-title-row">
          <div>
            <h2>Dívidas / contas</h2>
            <small>Conta, valor, pago parcial e parcelas distribuídas por mês.</small>
          </div>
        </div>

        <div class="calendar-shell">
          <div class="month-header">
            <div>
              <h3 id="titulo-mes-dividas">Mês de referência</h3>
              <small class="texto-menor">
                Cada parcela já cai no mês correto. Clique no status pra alternar pendente / parcial / pago.
              </small>
            </div>
            <div>
              <button class="month-nav-btn" onclick="mudarMesDividas(-1)">‹</button>
              <button class="month-nav-btn" onclick="mudarMesDividas(1)">›</button>
            </div>
          </div>

          <div class="resumo-dividas-grid">
            <div class="card-resumo-divida">
              <h4>Total deste mês (todas parcelas)</h4>
              <p id="resumo-dividas-total-mes" class="valor valor-bad">R$ 0,00</p>
            </div>
            <div class="card-resumo-divida">
              <h4>Já pago neste mês</h4>
              <p id="resumo-dividas-quitado-mes" class="valor valor-ok">R$ 0,00</p>
            </div>
            <div class="card-resumo-divida">
              <h4>Em aberto neste mês</h4>
              <p id="resumo-dividas-aberto-mes" class="valor valor-neutro">R$ 0,00</p>
            </div>
          </div>

          <div class="lista-dividas" id="lista-dividas-mes"></div>
        </div>

        <div class="form-shell">
          <div class="sec-title-row">
            <h3>Nova dívida / conta parcelada</h3>
            <small>
              O valor mensal é calculado automaticamente: valor total ÷ número de parcelas.
            </small>
          </div>

          <div class="form-grid">
            <div class="field">
              <label for="dv-mes-inicial">Mês inicial</label>
              <input id="dv-mes-inicial" type="month" />
            </div>

            <div class="field">
              <label for="dv-conta">Conta / descrição</label>
              <input id="dv-conta" type="text" placeholder="Cartão Nubank, câmera, viagem..." />
            </div>

            <div class="field">
              <label for="dv-valor-total">Valor total (R$)</label>
              <input id="dv-valor-total" type="number" step="0.01" min="0" placeholder="5500, 1200, 230..." />
            </div>

            <div class="field">
              <label for="dv-parcelas">Nº de parcelas</label>
              <input id="dv-parcelas" type="number" min="1" value="1" />
            </div>

            <div class="field">
              <label for="dv-obs">Observação</label>
              <textarea id="dv-obs" placeholder="Compra da R8, peças naro, viagem, etc."></textarea>
            </div>
          </div>

          <button class="btn-primary" onclick="salvarDivida()">Salvar dívida / parcelas</button>
        </div>
      </section>
    </div> <!-- card-main -->
  </div> <!-- app-shell -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // =========================
    // ESTADO & LOCALSTORAGE
    // =========================

    const STORAGE_KEY = "painelFinanceiroPrestes-v3";

    const hoje = new Date();
    function criaMesObj(baseDate) {
      return { ano: baseDate.getFullYear(), mes: baseDate.getMonth() }; // 0-11
    }

    let state = {
      tema: "claro",
      aba: "dashboard",
      mesEventos: criaMesObj(hoje),
      mesDividas: criaMesObj(hoje),
      eventos: [],
      dividas: [] // cada parcela é um item
    };

    function carregarState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const salvo = JSON.parse(raw);
          state = { ...state, ...salvo };
        }
      } catch (e) {
        console.error("Erro ao carregar state", e);
      }
      aplicarTema();
    }

    function salvarState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function aplicarTema() {
      document.body.setAttribute("data-theme", state.tema || "claro");
      const label = document.getElementById("label-tema");
      if (label) {
        label.textContent =
          state.tema === "claro" ? "Modo claro ativo" : "Modo escuro ativo";
      }
    }

    function toggleTema() {
      state.tema = state.tema === "claro" ? "escuro" : "claro";
      aplicarTema();
      salvarState();
    }

    function mudarAba(aba) {
      state.aba = aba;
      document
        .querySelectorAll(".section")
        .forEach((s) => s.classList.remove("active"));
      document
        .querySelectorAll(".tab-btn")
        .forEach((b) => b.classList.remove("active"));

      const sec = document.getElementById("sec-" + aba);
      const tab = document.getElementById("tab-" + aba);
      if (sec) sec.classList.add("active");
      if (tab) tab.classList.add("active");

      if (aba === "dashboard") renderDashboard();
      if (aba === "eventos") renderEventos();
      if (aba === "dividas") renderDividasMesCompleto();
    }

    // Helpers de data / mês
    const MESES = [
      "janeiro","fevereiro","março","abril","maio","junho",
      "julho","agosto","setembro","outubro","novembro","dezembro"
    ];

    function mesObjToTitulo(m) {
      return `${MESES[m.mes]} de ${m.ano}`;
    }

    function adicionarMes(m, delta) {
      let ano = m.ano;
      let mes = m.mes + delta;
      while (mes < 0) { mes += 12; ano--; }
      while (mes > 11) { mes -= 12; ano++; }
      return { ano, mes };
    }

    function mesKeyFromObj(m) {
      const mm = String(m.mes + 1).padStart(2, "0");
      return `${m.ano}-${mm}`;
    }

    function formatarMoeda(n) {
      return "R$ " + Number(n || 0).toFixed(2);
    }

    // parse seguro pra não dar problema de fuso
    function parseDateStr(str) {
      if (!str || typeof str !== "string" || str.length < 10) return null;
      const [ano, mes, dia] = str.split("-").map(Number);
      if (!ano || !mes || !dia) return null;
      return { ano, mes: mes - 1, dia };
    }
        // =====================
    // EVENTOS
    // =====================

    function salvarEvento() {
      const nome = document.getElementById("ev-nome").value.trim();
      const empresa = document.getElementById("ev-empresa").value.trim();
      const data = document.getElementById("ev-data").value;
      const valor = parseFloat(document.getElementById("ev-valor").value || "0");
      const forma = document.getElementById("ev-forma").value.trim();
      const obs = document.getElementById("ev-obs").value.trim();

      if (!data || !nome) {
        alert("Preciso pelo menos do nome do evento e da data.");
        return;
      }

      const novo = {
        id: Date.now(),
        nome,
        empresa,
        data, // yyyy-mm-dd direto
        valor,
        forma,
        status: "pendente",
        obs
      };

      state.eventos.push(novo);
      salvarState();

      document.getElementById("ev-nome").value = "";
      document.getElementById("ev-empresa").value = "";
      document.getElementById("ev-data").value = "";
      document.getElementById("ev-valor").value = "";
      document.getElementById("ev-forma").value = "";
      document.getElementById("ev-obs").value = "";

      renderEventos();
      renderDashboard();
    }

    function mudarMesEventos(delta) {
      state.mesEventos = adicionarMes(state.mesEventos, delta);
      renderEventos();
    }

    function eventosDoMes(mesObj) {
      const mes = mesObj.mes;
      const ano = mesObj.ano;
      return state.eventos.filter((ev) => {
        const parsed = parseDateStr(ev.data);
        if (!parsed) return false;
        return parsed.mes === mes && parsed.ano === ano;
      });
    }

    function girarStatusEvento(id) {
      const ev = state.eventos.find((e) => e.id === id);
      if (!ev) return;
      if (ev.status === "pendente") ev.status = "parcial";
      else if (ev.status === "parcial") ev.status = "pago";
      else ev.status = "pendente";
      salvarState();
      renderEventos();
      renderDashboard();
    }

    function renderEventos() {
      const titulo = document.getElementById("titulo-mes-eventos");
      if (titulo) titulo.textContent = mesObjToTitulo(state.mesEventos);

      const grid = document.getElementById("grid-eventos");
      if (!grid) return;
      grid.innerHTML = "";

      const diasSemana = ["D", "S", "T", "Q", "Q", "S", "S"];
      diasSemana.forEach((d) => {
        const h = document.createElement("div");
        h.className = "cal-header";
        h.textContent = d;
        grid.appendChild(h);
      });

      const primeiroDia = new Date(state.mesEventos.ano, state.mesEventos.mes, 1);
      const offset = primeiroDia.getDay();
      const diasNoMes = new Date(
        state.mesEventos.ano,
        state.mesEventos.mes + 1,
        0
      ).getDate();

      const eventosMes = eventosDoMes(state.mesEventos);

      for (let i = 0; i < offset; i++) {
        const vazio = document.createElement("div");
        grid.appendChild(vazio);
      }

      for (let dia = 1; dia <= diasNoMes; dia++) {
        const cell = document.createElement("div");
        cell.className = "cal-cell";

        const num = document.createElement("div");
        num.className = "cal-day-num";
        num.textContent = dia;
        cell.appendChild(num);

        const badgesBox = document.createElement("div");
        badgesBox.className = "cal-badges";

        const diaStr = String(dia).padStart(2, "0");
        const mesStr = String(state.mesEventos.mes + 1).padStart(2, "0");
        const keyDia = `${state.mesEventos.ano}-${mesStr}-${diaStr}`;

        const eventosDia = eventosMes.filter((ev) => ev.data === keyDia);
        eventosDia.forEach((ev) => {
          const b = document.createElement("button");
          b.className = "cal-badge";
          b.textContent = (ev.nome || "Ev").slice(0, 3) + "...";
          b.title =
            `${ev.nome || ""} • ${ev.empresa || ""} • ${formatarMoeda(ev.valor)} • ${ev.status}`;
          b.onclick = () => girarStatusEvento(ev.id);
          badgesBox.appendChild(b);
        });

        cell.appendChild(badgesBox);
        grid.appendChild(cell);
      }
    }

    // =====================
    // DÍVIDAS / PARCELAS
    // =====================

    function salvarDivida() {
      const mesInicial = document.getElementById("dv-mes-inicial").value;
      const conta = document.getElementById("dv-conta").value.trim();
      const valorTotal = parseFloat(
        document.getElementById("dv-valor-total").value || "0"
      );
      let parcelas = parseInt(document.getElementById("dv-parcelas").value || "1");
      const obs = document.getElementById("dv-obs").value.trim();

      if (!mesInicial || !conta || !valorTotal) {
        alert("Preciso de mês inicial, conta e valor total.");
        return;
      }
      if (parcelas < 1) parcelas = 1;

      const [anoStr, mesStr] = mesInicial.split("-");
      let ano = parseInt(anoStr);
      let mes = parseInt(mesStr) - 1;

      const valorMensal = valorTotal / parcelas;

      for (let i = 0; i < parcelas; i++) {
        const m = adicionarMes({ ano, mes }, i);
        const mesRefKey = mesKeyFromObj(m);

        const parcelaItem = {
          id: Date.now() + i,
          conta,
          obs,
          parcelas,
          parcelaIndex: i + 1,
          valorTotal,
          valorMensal,
          mesReferencia: mesRefKey,
          status: "pendente",
        };

        state.dividas.push(parcelaItem);
      }

      salvarState();

      document.getElementById("dv-mes-inicial").value = "";
      document.getElementById("dv-conta").value = "";
      document.getElementById("dv-valor-total").value = "";
      document.getElementById("dv-parcelas").value = "1";
      document.getElementById("dv-obs").value = "";

      renderDividasMesCompleto();
      renderDashboard();
    }

    function dividasDoMes(mesObj) {
      const key = mesKeyFromObj(mesObj);
      return state.dividas.filter((d) => d.mesReferencia === key);
    }

    function girarStatusDivida(id) {
      const d = state.dividas.find((x) => x.id === id);
      if (!d) return;
      if (d.status === "pendente") d.status = "parcial";
      else if (d.status === "parcial") d.status = "pago";
      else d.status = "pendente";
      salvarState();
      renderDividasMesCompleto();
      renderDashboard();
    }

    function mudarMesDividas(delta) {
      state.mesDividas = adicionarMes(state.mesDividas, delta);
      renderDividasMesCompleto();
      renderDashboard();
    }

    function calcularTotaisDividasMes(mesObj) {
      const key = mesKeyFromObj(mesObj);
      const divMes = state.dividas.filter((d) => d.mesReferencia === key);

      let totalMes = 0;
      let totalQuitado = 0;
      let totalParcial = 0;

      divMes.forEach((d) => {
        const v = d.valorMensal || d.valorTotal;
        totalMes += v;
        if (d.status === "pago") totalQuitado += v;
        if (d.status === "parcial") totalParcial += v;
      });

      return { totalMes, totalQuitado, totalParcial };
    }

    // total geral = soma de TODAS as parcelas (fixas + parceladas)
    function calcularTotalDividasGeral() {
      return state.dividas.reduce(
        (acc, d) => acc + (d.valorMensal || d.valorTotal || 0),
        0
      );
    }

    function renderDividasMesCompleto() {
      const titulo = document.getElementById("titulo-mes-dividas");
      if (titulo) titulo.textContent = mesObjToTitulo(state.mesDividas);

      const lista = document.getElementById("lista-dividas-mes");
      if (!lista) return;
      lista.innerHTML = "";

      const divMes = dividasDoMes(state.mesDividas);

      if (divMes.length === 0) {
        const vazio = document.createElement("p");
        vazio.className = "texto-menor";
        vazio.textContent = "Nenhuma dívida cadastrada pra este mês.";
        lista.appendChild(vazio);
      } else {
        divMes.forEach((d) => {
          const card = document.createElement("div");
          card.className = "divida-card";

          const main = document.createElement("div");
          main.className = "divida-main";

          const tituloConta = document.createElement("strong");
          tituloConta.textContent = d.conta;
          main.appendChild(tituloConta);

          const valorMes = d.valorMensal || d.valorTotal;

          const spanValor = document.createElement("span");
          spanValor.textContent = `Valor deste mês: ${formatarMoeda(valorMes)}`;
          main.appendChild(spanValor);

          const spanParcela = document.createElement("span");
          spanParcela.textContent =
            d.parcelas > 1
              ? `Parcela ${d.parcelaIndex}/${d.parcelas} • total ${formatarMoeda(
                  d.valorTotal
                )}`
              : `Dívida única • total ${formatarMoeda(d.valorTotal)}`;
          main.appendChild(spanParcela);

          if (d.obs) {
            const spanObs = document.createElement("span");
            spanObs.textContent = `Obs: ${d.obs}`;
            main.appendChild(spanObs);
          }

          const actions = document.createElement("div");
          actions.className = "divida-actions";

          const statusBtn = document.createElement("button");
          statusBtn.className = "tag-status " + d.status;
          statusBtn.textContent =
            d.status === "pendente"
              ? "Pendente"
              : d.status === "parcial"
              ? "Pago parcial"
              : "Quitado";
          statusBtn.onclick = () => girarStatusDivida(d.id);

          const giroBtn = document.createElement("button");
          giroBtn.className = "btn-status";
          giroBtn.textContent = "Girar status";
          giroBtn.onclick = () => girarStatusDivida(d.id);

          actions.appendChild(statusBtn);
          actions.appendChild(giroBtn);

          card.appendChild(main);
          card.appendChild(actions);

          lista.appendChild(card);
        });
      }

      const { totalMes, totalQuitado } = calcularTotaisDividasMes(state.mesDividas);

      const elTotal = document.getElementById("resumo-dividas-total-mes");
      const elQuit = document.getElementById("resumo-dividas-quitado-mes");
      const elAberto = document.getElementById("resumo-dividas-aberto-mes");

      if (elTotal) elTotal.textContent = formatarMoeda(totalMes);
      if (elQuit) elQuit.textContent = formatarMoeda(totalQuitado);
      if (elAberto) elAberto.textContent = formatarMoeda(totalMes - totalQuitado);
    }
        // =====================
    // DASHBOARD
    // =====================

    function renderDashboard() {
      const totalEventos = state.eventos.reduce(
        (acc, ev) => acc + (ev.valor || 0),
        0
      );
      const eventosPagos = state.eventos.filter((e) => e.status === "pago");
      const receitaConfirmada = eventosPagos.reduce(
        (acc, ev) => acc + (ev.valor || 0),
        0
      );

      const eventosParciais = state.eventos.filter(
        (e) => e.status === "parcial"
      );
      const potencialParcial = eventosParciais.reduce(
        (acc, ev) => acc + (ev.valor || 0),
        0
      );

      const { totalMes, totalQuitado, totalParcial } =
        calcularTotaisDividasMes(state.mesDividas);

      const totalGeralDividas = calcularTotalDividasGeral();

      const elRecConf = document.getElementById("dash-receita-confirmada");
      const elTotEv = document.getElementById("dash-total-eventos");
      const elEvParc = document.getElementById("dash-eventos-parciais");
      const elEvParcVal = document.getElementById(
        "dash-eventos-parciais-valor"
      );
      const elDivMesTot = document.getElementById("dash-dividas-mes-total");
      const elDivMesQuit = document.getElementById(
        "dash-dividas-mes-quitadas"
      );
      const elDivGeralTot = document.getElementById(
        "dash-dividas-geral-total"
      );
      const elDivParc = document.getElementById("dash-dividas-parciais");
      const elDivParcVal = document.getElementById(
        "dash-dividas-parciais-valor"
      );
      const elFluxo = document.getElementById("dash-fluxo-liquido");

      if (elRecConf) elRecConf.textContent = formatarMoeda(receitaConfirmada);
      if (elTotEv)
        elTotEv.textContent = `Total em eventos: ${formatarMoeda(
          totalEventos
        )}`;
      if (elEvParc)
        elEvParc.textContent = `${eventosParciais.length} evento(s)`;
      if (elEvParcVal)
        elEvParcVal.textContent = `Valor potencial: ${formatarMoeda(
          potencialParcial
        )}`;

      if (elDivMesTot) elDivMesTot.textContent = formatarMoeda(totalMes);
      if (elDivMesQuit)
        elDivMesQuit.textContent = `Quitadas neste mês: ${formatarMoeda(
          totalQuitado
        )}`;
      if (elDivGeralTot)
        elDivGeralTot.textContent = `Total geral (todas dívidas): ${formatarMoeda(
          totalGeralDividas
        )}`;

      const divParciaisMes = dividasDoMes(state.mesDividas).filter(
        (d) => d.status === "parcial"
      );
      if (elDivParc)
        elDivParc.textContent = `${divParciaisMes.length} conta(s)`;
      if (elDivParcVal)
        elDivParcVal.textContent = `Valor deste mês: ${formatarMoeda(
          totalParcial
        )}`;

      const fluxoLiquido = receitaConfirmada - totalQuitado;
      if (elFluxo) elFluxo.textContent = formatarMoeda(fluxoLiquido);

      renderLinhaTempo();
    }

    function renderLinhaTempo() {
      const cont = document.getElementById("linha-tempo-lista");
      if (!cont) return;
      cont.innerHTML = "";

      const itens = [];

      state.eventos.forEach((ev) => {
        itens.push({
          tipo: "evento",
          data: ev.data || "",
          rotulo: ev.nome || "Evento",
          extra: ev.empresa || "",
          valor: ev.valor || 0,
          status: ev.status,
        });
      });

      state.dividas.forEach((d) => {
        const data = d.mesReferencia ? d.mesReferencia + "-01" : "";
        itens.push({
          tipo: "divida",
          data,
          rotulo: d.conta || "Conta",
          extra:
            d.parcelas > 1
              ? `Parcela ${d.parcelaIndex}/${d.parcelas}`
              : "Dívida única",
          valor: d.valorMensal || d.valorTotal || 0,
          status: d.status,
        });
      });

      itens.sort((a, b) => (a.data > b.data ? -1 : a.data < b.data ? 1 : 0));
      const recorte = itens.slice(0, 20);

      if (recorte.length === 0) {
        const vazio = document.createElement("p");
        vazio.className = "texto-menor";
        vazio.textContent = "Nada cadastrado ainda.";
        cont.appendChild(vazio);
        return;
      }

      recorte.forEach((it) => {
        const linha = document.createElement("div");
        linha.className = "linha-item";

        const info = document.createElement("div");
        info.className = "linha-info";

        const s1 = document.createElement("strong");
        s1.textContent =
          (it.tipo === "evento" ? "Evento · " : "Dívida · ") + it.rotulo;
        info.appendChild(s1);

        const s2 = document.createElement("span");
        s2.textContent = `${it.extra || ""} ${
          it.data ? "· " + it.data : ""
        }`.trim();
        info.appendChild(s2);

        const valor = document.createElement("span");
        valor.className = "texto-menor";
        valor.textContent = formatarMoeda(it.valor);
        info.appendChild(valor);

        const tag = document.createElement("div");
        tag.className = "tag-status " + it.status;
        tag.textContent =
          it.status === "pendente"
            ? "Pendente"
            : it.status === "parcial"
            ? "Pago parcial"
            : "Quitado";

        linha.appendChild(info);
        linha.appendChild(tag);
        cont.appendChild(linha);
      });
    }

    // =====================
    // PDF – versão mais organizada
    // =====================

    function exportarPDFCompleto() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 18;

      function novaPaginaSePreciso(extra = 6) {
        if (y + extra > 280) {
          doc.addPage();
          y = 18;
        }
      }

      function tituloCentral(txt) {
        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        const w = doc.getTextWidth(txt);
        doc.text(txt, (210 - w) / 2, y);
        y += 8;
        doc.setLineWidth(0.3);
        doc.line(10, y, 200, y);
        y += 6;
      }

      function subtitulo(txt) {
        novaPaginaSePreciso();
        doc.setFont("helvetica", "bold");
        doc.setFontSize(13);
        doc.text(txt, 10, y);
        y += 6;
      }

      function linha(txt, indent = 0) {
        novaPaginaSePreciso();
        doc.setFont("helvetica", "normal");
        doc.setFontSize(11);
        doc.text(txt, 10 + indent, y);
        y += 5;
      }

      // Cabeçalho
      tituloCentral("Relatório financeiro • Prestes");

      const mesTitulo = mesObjToTitulo(state.mesDividas);
      linha("Mês de referência para dívidas: " + mesTitulo);

      const totMes = calcularTotaisDividasMes(state.mesDividas);
      const totalGeralDividas = calcularTotalDividasGeral();

      linha(
        "Total de dívidas do mês: " + formatarMoeda(totMes.totalMes),
        2
      );
      linha(
        "Quitadas neste mês: " + formatarMoeda(totMes.totalQuitado),
        2
      );
      linha(
        "Em aberto neste mês: " +
          formatarMoeda(totMes.totalMes - totMes.totalQuitado),
        2
      );
      linha(
        "Total geral de todas as dívidas (todas parcelas): " +
          formatarMoeda(totalGeralDividas),
        2
      );

      y += 4;

      // EVENTOS
      subtitulo("Eventos");

      if (state.eventos.length === 0) {
        linha("Nenhum evento cadastrado.", 2);
      } else {
        const eventosOrdenados = state.eventos
          .slice()
          .sort((a, b) => (a.data > b.data ? 1 : -1));

        eventosOrdenados.forEach((ev) => {
          novaPaginaSePreciso(12);
          linha(
            `• ${ev.nome || "Evento"}  •  ${formatarMoeda(
              ev.valor
            )}  •  status: ${(ev.status || "pendente").toUpperCase()}`,
            2
          );
          if (ev.data) linha(`Data: ${ev.data}`, 6);
          if (ev.empresa) linha(`Empresa / cliente: ${ev.empresa}`, 6);
          if (ev.forma) linha(`Forma de pagamento: ${ev.forma}`, 6);
          if (ev.obs) linha(`Obs: ${ev.obs}`, 6);
          y += 2;
        });
      }

      y += 4;

      // DÍVIDAS
      subtitulo("Dívidas / contas (todas parcelas)");

      if (state.dividas.length === 0) {
        linha("Nenhuma dívida cadastrada.", 2);
      } else {
        const divsOrdenadas = state.dividas
          .slice()
          .sort((a, b) =>
            a.mesReferencia > b.mesReferencia ? 1 : -1
          );

        divsOrdenadas.forEach((d) => {
          novaPaginaSePreciso(12);
          const vMes = d.valorMensal || d.valorTotal;
          linha(
            `• ${d.conta || "Conta"}  •  mês: ${
              d.mesReferencia || "-"
            }  •  ${formatarMoeda(vMes)} (de ${formatarMoeda(
              d.valorTotal
            )})  •  status: ${(d.status || "pendente").toUpperCase()}`,
            2
          );
          if (d.parcelas > 1)
            linha(
              `Parcela ${d.parcelaIndex}/${d.parcelas}`,
              6
            );
          if (d.obs) linha(`Obs: ${d.obs}`, 6);
          y += 2;
        });
      }

      doc.save("relatorio-financeiro-prestes.pdf");
    }

    // =====================
    // INIT
    // =====================

    carregarState();
    aplicarTema();
    renderEventos();
    renderDividasMesCompleto();
    renderDashboard();
  </script>
</body>
</html>
