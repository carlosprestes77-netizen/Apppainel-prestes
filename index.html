<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#d7b478" />

<link rel="manifest" href="manifest.webmanifest" />

<title>Painel Prestes</title>

<style>
:root{
  --gold:#d7b478;
  --gold-light:#f3e7d6;
  --bg:#1d1814;
  --bg-card:#2b241e;
  --bg-alt:#3a3028;
  --border:#463a2e;
  --text:#f5e9d5;
  --text-dark:#1d1814;
  --danger:#d96e6e;
}

*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family:Inter,Arial,sans-serif;
}

body{
  background:var(--bg);
  color:var(--text);
  padding:18px;
}

/* HEADER */
header{
  display:flex;
  align-items:center;
  gap:14px;
  margin-bottom:22px;
}

.logoCP{
  width:62px;
  height:62px;
  background:linear-gradient(145deg,#fdf7ec,#c6a87a);
  border-radius:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:26px;
  font-weight:900;
  color:#1a1a1a;
  box-shadow:0 4px 12px rgba(0,0,0,0.35);
}

h1{
  font-size:28px;
  font-weight:800;
  color:var(--gold-light);
}

/* TABS */
.tabs{
  display:flex;
  gap:12px;
  margin-bottom:20px;
}

.tab{
  flex:1;
  padding:12px;
  background:var(--bg-card);
  text-align:center;
  border-radius:14px;
  border:1px solid var(--border);
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  color:var(--gold-light);
}

.tab.active{
  background:var(--gold);
  color:var(--text-dark);
  box-shadow:0 3px 12px rgba(215,180,120,0.45);
}

/* CARDS */
.card{
  background:var(--bg-card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:18px;
  margin-bottom:22px;
  box-shadow:0 4px 10px rgba(0,0,0,0.25);
}

.card h2{
  font-size:22px;
  margin-bottom:12px;
}

/* INPUTS */
.input{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--bg-alt);
  margin-bottom:12px;
  font-size:16px;
  color:var(--text);
}

/* BUTTON */
.btn{
  width:100%;
  background:var(--gold);
  color:var(--text-dark);
  border:none;
  padding:14px;
  margin-top:8px;
  font-size:16px;
  font-weight:800;
  border-radius:14px;
  cursor:pointer;
  box-shadow:0 3px 10px rgba(215,180,120,0.4);
}

.btn-danger{
  background:var(--danger);
  color:white;
}

.lista{
  display:flex;
  flex-direction:column;
  gap:12px;
}

.item{
  background:var(--bg-alt);
  border-radius:14px;
  border:1px solid var(--border);
  padding:14px;
}

.itemHeader{
  display:flex;
  justify-content:space-between;
  font-size:17px;
  font-weight:700;
  margin-bottom:6px;
}

/* CALEND√ÅRIO */
.monthHeader{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
  font-size:20px;
  font-weight:700;
  color:var(--gold-light);
}

.monthBtn{
  background:none;
  border:none;
  color:var(--gold);
  font-size:28px;
  cursor:pointer;
}

.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:10px;
}

.day{
  padding:14px 0;
  background:var(--bg-alt);
  border-radius:14px;
  text-align:center;
  font-weight:600;
  cursor:pointer;
}

.day.has{
  background:var(--gold);
  color:var(--text-dark);
  font-weight:800;
}
/* ============================
   TELAS
============================ */

#telaDashboard,
#telaDividas,
#telaEventos {
  display:none;
}

#telaDashboard.active,
#telaDividas.active,
#telaEventos.active {
  display:block;
}

/* ALERTAS DASHBOARD */
.alerta{
  background:#3a3028;
  border-left:4px solid var(--gold);
  padding:12px;
  border-radius:12px;
  margin:8px 0;
  font-size:15px;
  opacity:0.9;
}

/* MODAL */
#modalFundo{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.65);
  display:none;
  align-items:center;
  justify-content:center;
  padding:20px;
  z-index:900;
}

.modalBox{
  background:var(--bg-card);
  padding:20px;
  width:100%;
  max-width:380px;
  border-radius:18px;
  border:1px solid var(--border);
  animation:pop 0.3s ease;
}

@keyframes pop{
  0%{transform:scale(0.9);opacity:0;}
  100%{transform:scale(1);opacity:1;}
}

</style>
</head>

<body>

<header>
  <div class="logoCP">CP</div>
  <h1>Painel Prestes</h1>
</header>

<div class="tabs">
  <div class="tab active" id="tabDash">Dashboard</div>
  <div class="tab" id="tabDiv">D√≠vidas</div>
  <div class="tab" id="tabEve">Eventos</div>
</div>

<!-- TELAS -->
<div id="telaDashboard" class="active"></div>
<div id="telaDividas"></div>
<div id="telaEventos"></div>

<!-- MODAL GLOBAL -->
<div id="modalFundo">
  <div class="modalBox" id="modalConteudo"></div>
</div>

<script>

/* ============================
   STORAGE
============================ */
let dividas = JSON.parse(localStorage.getItem("dividas") || "[]");
let eventos = JSON.parse(localStorage.getItem("eventos") || "[]");

function saveAll(){
  localStorage.setItem("dividas", JSON.stringify(dividas));
  localStorage.setItem("eventos", JSON.stringify(eventos));
}

/* ============================
   CONTROLE DE ABAS
============================ */
function abrirAba(id){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll("#telaDashboard, #telaDividas, #telaEventos").forEach(t=>t.classList.remove("active"));

  if(id==="dash"){
    tabDash.classList.add("active");
    telaDashboard.classList.add("active");
    renderDashboard();
  }
  if(id==="div"){
    tabDiv.classList.add("active");
    telaDividas.classList.add("active");
    renderDividas();
  }
  if(id==="eve"){
    tabEve.classList.add("active");
    telaEventos.classList.add("active");
    renderEventos();
  }
}

tabDash.onclick = ()=>abrirAba("dash");
tabDiv.onclick = ()=>abrirAba("div");
tabEve.onclick = ()=>abrirAba("eve");


/* ============================================================
   DASHBOARD H√çBRIDO (Resumo + gr√°ficos + alertas)
============================================================ */
function renderDashboard(){
  let total = dividas.reduce((s,d)=>s+Number(d.valor),0);
  let recebido = dividas.reduce((s,d)=>s+Number(d.recebido||0),0);
  let falta = total - recebido;

  // ALERTAS inteligentes
  const alertas = [];

  for(const d of dividas){
    if(d.tipo==="recorrente"){
      alertas.push(`üîî D√≠vida recorrente ativa: ${d.nome}`);
    }
    if(d.recebido < d.valor && d.recebido > 0){
      alertas.push(`üü° Pagamento parcial em ${d.nome}`);
    }
  }

  for(const e of eventos){
    if(e.recebido < e.valor){
      alertas.push(`üì∑ Evento pendente: ${e.nome}`);
    }
  }

  telaDashboard.innerHTML = `
    <div class="card">
      <h2>Resumo Financeiro</h2>
      <p>Total: <b>R$ ${total.toFixed(2)}</b></p>
      <p>Recebido: <b>R$ ${recebido.toFixed(2)}</b></p>
      <p>Falta: <b>R$ ${falta.toFixed(2)}</b></p>
    </div>

    <div class="card">
      <h2>Alertas</h2>
      ${alertas.length === 0 
        ? "<p>Nenhum alerta no momento.</p>" 
        : alertas.map(a=>`<div class='alerta'>${a}</div>`).join("")}
    </div>

    <div class="card">
      <h2>Gr√°fico (breve)</h2>
      <p>O gr√°fico ser√° carregado na parte 4.</p>
    </div>
  `;
}


/* ============================================================
   D√çVIDAS (COM PARCELAS + RECORR√äNCIA v3)
============================================================ */

function renderDividas(){
  telaDividas.innerHTML = `
    <div class="card">
      <h2>Adicionar d√≠vida</h2>

      <input class="input" id="dNome" placeholder="Nome">
      <input class="input" id="dValor" placeholder="Valor total">
      <input class="input" id="dReceb" placeholder="Recebido (opcional)">
      
      <select class="input" id="dTipo">
        <option value="unica">√önica</option>
        <option value="recorrente">Recorrente todo m√™s</option>
        <option value="parcelada">Parcelada (X vezes)</option>
      </select>

      <input class="input" id="dParcelas" placeholder="Parcelas (se parcelada)">
      <input class="input" id="dFim" placeholder="M√™s final (se recorrente)">
      
      <button class="btn" onclick="addDivida()">Adicionar</button>
    </div>

    <div class="card">
      <h2>Minhas d√≠vidas</h2>
      <div class="lista">
        ${dividas.map((d,i)=>`
          <div class="item">
            <div class="itemHeader">
              <span>${d.nome}</span>
              <b>R$ ${d.valor}</b>
            </div>
            <p>Tipo: ${d.tipo}</p>
            <p>Recebido: R$ ${d.recebido || 0}</p>

            <button class="btn-danger" onclick="removerDivida(${i})">Remover</button>
          </div>
        `).join("")}
      </div>
    </div>
  `;
}

// ADICIONAR D√çVIDA
function addDivida(){
  const nome = dNome.value;
  const valor = Number(dValor.value);
  const recebido = Number(dReceb.value || 0);
  const tipo = dTipo.value;
  const parcelas = Number(dParcelas.value || 0);
  const fim = dFim.value;

  if(!nome || !valor){
    alert("Nome e valor s√£o obrigat√≥rios");
    return;
  }
  /* ============================================================
   EVENTOS ‚Äî SISTEMA COMPLETO (Aba + Modal + Calend√°rio)
============================================================ */

let mesEve = new Date().getMonth();
let anoEve = new Date().getFullYear();

const mesesNomes = [
  "Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho",
  "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
];

/* RENDERIZAR TELA DE EVENTOS */
function renderEventos(){
  const primeiroDia = new Date(anoEve, mesEve, 1).getDay();
  const diasNoMes = new Date(anoEve, mesEve+1, 0).getDate();

  let calendario = "";
  calendario += "<div class='monthHeader'>";
  calendario += `<button class='monthBtn' onclick='mesEve--;renderEventos()'>&larr;</button>`;
  calendario += `${mesesNomes[mesEve]} ${anoEve}`;
  calendario += `<button class='monthBtn' onclick='mesEve++;renderEventos()'>&rarr;</button>`;
  calendario += "</div>";

  // GRID DO CALEND√ÅRIO
  calendario += "<div class='calendar'>";
  calendario += "<div></div>".repeat(primeiroDia);

  for(let d = 1; d <= diasNoMes; d++){
    const temEvento = eventos.some(ev => ev.dia == d && ev.mes == mesEve && ev.ano == anoEve);

    calendario += `
      <div class="day ${temEvento?"has":""}" onclick="abrirModalEvento(${d})">
        ${d}
      </div>`;
  }
  calendario += "</div>";

  // LISTA DE EVENTOS
  let listaE = `
    <div class="card">
      <h2>Todos os eventos</h2>
      <div class="lista">
        ${eventos.map(ev => `
          <div class="item">
            <div class="itemHeader">
              <span>${ev.empresa}</span>
              <b>R$ ${ev.recebido}/${ev.valor}</b>
            </div>
            <p>${ev.servico}</p>
            <p>${ev.dia}/${ev.mes+1}/${ev.ano}</p>
            <button class="btn-danger" onclick="removerEvento(${eventos.indexOf(ev)})">
              Remover
            </button>
          </div>
        `).join("")}
      </div>
    </div>
  `;

  telaEventos.innerHTML = `
    <div class="card">
      <h2>Calend√°rio de eventos</h2>
      ${calendario}
    </div>

    ${listaE}
  `;
}

/* MODAL DE EVENTO */
function abrirModalEvento(dia){
  modalFundo.style.display = "flex";
  modalConteudo.innerHTML = `
    <h2>Novo Evento ‚Äì Dia ${dia}</h2>

    <input class="input" id="evEmpresa" placeholder="Empresa">
    <input class="input" id="evServico" placeholder="Servi√ßo / Tipo de evento">
    <input class="input" id="evValor" placeholder="Valor total">
    <input class="input" id="evRecebido" placeholder="Recebido / parcial (opcional)">
    <textarea class="input" id="evObs" placeholder="Observa√ß√µes" style="height:90px"></textarea>

    <button class="btn" onclick="addEvento(${dia})">Salvar evento</button>
    <button class="btn-danger" onclick="fecharModal()">Cancelar</button>
  `;
}

function fecharModal(){
  modalFundo.style.display = "none";
}

function addEvento(dia){
  const empresa = evEmpresa.value;
  const servico = evServico.value;
  const valor = Number(evValor.value);
  const recebido = Number(evRecebido.value || 0);
  const obs = evObs.value || "";

  if(!empresa || !servico || !valor){
    alert("Preencha empresa, servi√ßo e valor!");
    return;
  }

  eventos.push({
    empresa,
    servico,
    valor,
    recebido,
    obs,
    dia,
    mes: mesEve,
    ano: anoEve
  });

  saveAll();
  fecharModal();
  renderEventos();
  renderDashboard();
}

function removerEvento(i){
  eventos.splice(i,1);
  saveAll();
  renderEventos();
  renderDashboard();
}
/* =========================================================================
   PARTE 4 ‚Äî JAVASCRIPT FINAL (GR√ÅFICOS + BACKUP + PDF + PWA)
=========================================================================== */

</style>
</head>
<body>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

/* ==========================================================
   GR√ÅFICOS
========================================================== */

let pizza = null;
let barras = null;

function atualizarGraficos(){
  const ctx1 = document.getElementById("grafPizza");
  const ctx2 = document.getElementById("grafBarras");

  if(!ctx1 || !ctx2) return;

  const total = dividas.reduce((s,d)=>s+d.valor,0);
  const recebido = dividas.reduce((s,d)=>s+(d.recebido||0),0);
  const falta = total - recebido;

  // ------- PIZZA -------
  if(pizza) pizza.destroy();

  pizza = new Chart(ctx1,{
    type:"pie",
    data:{
      labels:["Recebido","Falta"],
      datasets:[{
        data:[recebido,falta],
        backgroundColor:["#d7b478","#9e8655"]
      }]
    }
  });

  // ------- BARRAS -------
  if(barras) barras.destroy();

  const porMes = Array(12).fill(0);
  eventos.forEach(ev=>{
    porMes[ev.mes] += ev.recebido;
  });

  barras = new Chart(ctx2,{
    type:"bar",
    data:{
      labels:["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"],
      datasets:[{
        label:"Recebido por m√™s",
        backgroundColor:"#d7b478",
        data:porMes
      }]
    }
  });
}

/* ==========================================================
   SISTEMA DE BACKUP / RESTORE
========================================================== */

function gerarBackup(){
  const data = {
    dividas,
    eventos
  };

  const blob = new Blob([JSON.stringify(data)],{type:"application/json"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "painel-prestes.cpbackup";
  a.click();

  URL.revokeObjectURL(url);
  alert("Backup gerado!");
}

function restaurarBackup(){
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = ".cpbackup,application/json";

  inp.onchange = ()=> {
    const file = inp.files[0];
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        dividas = data.dividas || [];
        eventos = data.eventos || [];
        saveAll();
        renderDashboard();
        renderDividas();
        renderEventos();
        atualizarGraficos();
        alert("Backup restaurado!");
      }catch(e){
        alert("Arquivo inv√°lido!");
      }
    };
    reader.readAsText(file);
  };

  inp.click();
}

/* ==========================================================
   PDF REAL DO M√äS
========================================================== */

function gerarPDF(){
  alert("Vers√£o real do PDF ativada depois ‚Äî estrutura pronta.");
}

/* ==========================================================
   RENDERIZA√á√ÉO COMPLETA
========================================================== */

function renderCompleto(){
  renderDashboard();
  renderDividas();
  renderEventos();
  atualizarGraficos();
}

/* ==========================================================
   INICIALIZA√á√ÉO DO APP
========================================================== */

document.addEventListener("DOMContentLoaded",()=>{

  // inserir os gr√°ficos no Dashboard
  telaDashboard.innerHTML += `
    <div class="card">
      <h2>Gr√°fico Financeiro</h2>
      <canvas id="grafPizza"></canvas>
    </div>

    <div class="card">
      <h2>Recebido por m√™s</h2>
      <canvas id="grafBarras"></canvas>
    </div>

    <div class="card">
      <button class="btn" onclick="gerarBackup()">üì¶ Backup</button>
      <button class="btn" onclick="restaurarBackup()">‚ôªÔ∏è Restaurar</button>
    </div>
  `;

  renderCompleto();
});

/* ==========================================================
   REGISTRO DO PWA
========================================================== */

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}

</script>

</body>
</html> 
